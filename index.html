<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudiumOS - Modern Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* CSS for StudiumOS Dashboard */
        :root {
            --primary-bg: #f0f2f5;
            --secondary-bg: #ffffff;
            --tertiary-bg: #e0e2e5; /* For widget resizing handles or subtle backgrounds */
            --text-color: #333;
            --text-color-light: #666;
            --border-color: #e0e0e0;
            --accent-color: #007bff; /* Default accent color */
            --accent-color-dark: #0056b3;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
            --transition-speed: 0.3s ease;
            --grid-gap: 20px;
        }

        [data-theme='dark'] {
            --primary-bg: #121212; /* Almost black */
            --secondary-bg: #1e1e1e; /* Darker grey */
            --tertiary-bg: #333333; /* Darker grey for subtle elements */
            --text-color: #e0e0e0;
            --text-color-light: #b0b0b0;
            --border-color: #3a3a4c;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Dynamic Accent Color Application */
        [data-accent-color] {
            --accent-color: var(--dynamic-accent-color);
            --accent-color-dark: color-mix(in srgb, var(--dynamic-accent-color) 80%, black); /* A bit darker for hover */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--primary-bg); /* Ensure body background changes */
            transition: background-color var(--transition-speed), color var(--transition-speed), background-image var(--transition-speed);
            overflow: hidden; /* Prevent body scroll, content will scroll within sections */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background-color: var(--primary-bg); /* Ensure app container background changes */
        }

        /* Main Dashboard Area - now takes full height */
        #dashboard-main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allows scrolling for the main content area */
            padding: var(--grid-gap);
            transition: background-color var(--transition-speed);
        }

        /* Floating Action Button for Add Widgets */
        #add-widget-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40px; /* Smaller size */
            height: 40px; /* Smaller size */
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            font-size: 1.3em; /* Smaller icon */
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            box-shadow: var(--shadow);
            cursor: pointer;
            z-index: 500; /* Below overlays, above dashboard */
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        #add-widget-fab:hover {
            background-color: var(--accent-color-dark);
            transform: translateY(-2px);
        }
        #add-widget-fab:active {
            transform: scale(0.95);
        }

        /* Floating Action Button for Settings */
        #settings-fab {
            position: fixed;
            bottom: 20px;
            right: 70px; /* Adjusted position for smaller FAB */
            width: 40px; /* Smaller size */
            height: 40px; /* Smaller size */
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            font-size: 1.3em; /* Smaller icon */
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            box-shadow: var(--shadow);
            cursor: pointer;
            z-index: 500;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        #settings-fab:hover {
            background-color: var(--accent-color-dark);
            transform: translateY(-2px);
        }
        #settings-fab:active {
            transform: scale(0.95);
        }


        #widget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* Responsive grid */
            grid-auto-rows: minmax(250px, auto); /* Flexible row height based on content */
            gap: var(--grid-gap);
            flex-grow: 1;
            min-height: 100%; /* Ensure grid takes full height of main */
            align-content: start; /* Ensures widgets align to the top */
            position: relative; /* For drag/resize positioning */
        }

        /* Widget Styles */
        .widget {
            background-color: var(--secondary-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: absolute; /* Changed to absolute for precise positioning during drag/resize */
            display: flex;
            flex-direction: column;
            /* Only transition properties that should animate normally, not position/size */
            transition: box-shadow var(--transition-speed), background-color var(--transition-speed), border-color var(--transition-speed), transform var(--transition-speed);
            min-width: 250px;
            min-height: 200px;
            border: 1px solid var(--border-color);
            padding: 0; /* No padding on the widget itself, content will have padding */
            cursor: grab; /* Indicates draggable */
        }


        .widget.dragging {
            cursor: grabbing;
            z-index: 101; /* Bring dragged widget to front */
            box-shadow: var(--shadow), 0 0 0 3px var(--accent-color); /* Highlight when dragging */
            opacity: 0.8;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid var(--tertiary-bg);
            flex-shrink: 0; /* Prevent header from shrinking */
            background-color: var(--secondary-bg); /* Ensure header background matches widget */
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }

        .widget-header h3 {
            font-size: 1.1em;
            color: var(--accent-color);
            font-weight: 600;
            white-space: nowrap; /* Prevent title wrapping */
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color var(--transition-speed);
        }

        .widget-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }

        .widget-actions button {
            background: none;
            border: none;
            color: var(--text-color-light);
            cursor: pointer;
            font-size: 0.9em;
            width: 28px;
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 4px;
            transition: color var(--transition-speed), background-color var(--transition-speed);
        }

        .widget-actions button:hover {
            color: var(--accent-color);
            background-color: var(--tertiary-bg);
        }

        .widget-content {
            flex-grow: 1;
            overflow: auto; /* Allows content within widget to scroll if it overflows */
            padding: 15px;
            display: flex; /* Make content a flex container */
            flex-direction: column; /* Arrange content vertically */
            justify-content: flex-start; /* Align content to start */
            align-items: stretch; /* Stretch content to fill width */
        }

        /* Resizer Handles */
        .widget-resizer {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: transparent; /* Made transparent */
            border: 1px solid transparent; /* Made transparent */
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s ease;
            z-index: 102; /* Above widget content */
            border-radius: 2px;
        }
        /* .widget:hover .widget-resizer {
            opacity: 0.7; /* Show on hover - REMOVED THIS TO MAKE THEM INVISIBLE */
        /* } */

        .resizer-br { bottom: 0; right: 0; cursor: nwse-resize; }
        .resizer-bl { bottom: 0; left: 0; cursor: nesw-resize; }
        .resizer-tr { top: 0; right: 0; cursor: nesw-resize; }
        .resizer-tl { top: 0; left: 0; cursor: nwse-resize; }
        .resizer-b { bottom: 0; left: 50%; transform: translateX(-50%); width: 80%; height: 8px; cursor: ns-resize; border-radius: 4px;}
        .resizer-t { top: 0; left: 50%; transform: translateX(-50%); width: 80%; height: 8px; cursor: ns-resize; border-radius: 4px;}
        .resizer-l { left: 0; top: 50%; transform: translateY(-50%); height: 80%; width: 8px; cursor: ew-resize; border-radius: 4px;}
        .resizer-r { right: 0; top: 50%; transform: translateY(-50%); height: 80%; width: 8px; cursor: ew-resize; border-radius: 4px;}

        /* Fullscreen Widget */
        .widget.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            border-radius: 0;
            box-shadow: none;
            padding: 0; /* Remove padding, content inside handles padding */
            background-color: var(--primary-bg); /* Use primary bg for fullscreen */
            transition: all var(--transition-speed); /* Smooth transition to fullscreen */
            cursor: default; /* Not draggable when fullscreen */
        }

        .widget.fullscreen .widget-header {
            border-bottom: 1px solid var(--border-color); /* Ensure border for fullscreen */
            border-radius: 0;
        }

        .widget.fullscreen .widget-content {
            height: calc(100% - 60px); /* Adjust height for header, assuming 60px header height */
            padding: 20px; /* More padding for fullscreen content */
        }

        .widget.fullscreen .widget-resizer {
            display: none; /* Hide resizers when fullscreen */
        }

        /* Overlay button visibility only when fullscreen */
        .widget-actions .overlay-btn {
            display: none; /* Hidden by default */
        }
        .widget.fullscreen .widget-actions .overlay-btn {
            display: inline-flex; /* Show when parent widget is fullscreen */
        }


        /* Widget Palette */
        #widget-palette {
            position: fixed;
            top: 0;
            right: 0;
            width: 350px;
            height: 100vh;
            background-color: var(--secondary-bg);
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
            z-index: 1001; /* Higher than fullscreen widget (1000) */
            transform: translateX(100%);
            transition: transform var(--transition-speed), background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
            display: flex;
            flex-direction: column;
            padding: 20px;
            border-left: 1px solid var(--border-color);
        }

        #widget-palette.visible {
            transform: translateX(0);
        }

        .palette-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--tertiary-bg);
            transition: border-color var(--transition-speed);
        }

        .palette-header h2 {
            font-size: 1.5em;
            color: var(--accent-color);
            transition: color var(--transition-speed);
        }

        .palette-header button {
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--text-color-light);
            cursor: pointer;
            transition: color var(--transition-speed);
        }

        .palette-header button:hover {
            color: var(--accent-color);
        }

        .widget-list {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px; /* For scrollbar spacing */
        }

        .widget-option {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background-color: var(--tertiary-bg);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color var(--transition-speed), transform 0.2s ease-out;
            border: 1px solid transparent; /* For hover effect */
        }

        .widget-option:hover {
            background-color: color-mix(in srgb, var(--tertiary-bg) 90%, var(--accent-color));
            transform: translateY(-2px);
            border-color: var(--accent-color);
        }

        .widget-option i {
            font-size: 1.8em;
            margin-right: 15px;
            color: var(--accent-color);
            transition: color var(--transition-speed);
        }

        .widget-option span {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--text-color);
            transition: color var(--transition-speed);
        }

        /* Overlay Container */
        #overlay-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: transparent; /* Changed to transparent */
            backdrop-filter: none; /* Removed blur */
            z-index: 1005; /* HIGHER than fullscreen widget (1000) */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed), visibility var(--transition-speed);
            padding: var(--grid-gap); /* Padding for the overlay content */
            pointer-events: none; /* Allow clicks to pass through to elements behind */
        }

        #overlay-container.visible {
            opacity: 1;
            visibility: visible;
        }

        .overlay-widget {
            background-color: var(--secondary-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative; /* For close button */
            transition: all var(--transition-speed);
            min-width: 300px;
            min-height: 250px;
            /* Allow overlays to be dragged/resized on top of fullscreen */
            position: absolute; /* Changed to absolute for precise positioning during drag/resize */
            cursor: grab;
            pointer-events: auto; /* Re-enable pointer events for the widget itself */
        }
        .overlay-widget.dragging {
            cursor: grabbing;
            z-index: 101; /* Bring dragged widget to front */
            box-shadow: var(--shadow), 0 0 0 3px var(--accent-color); /* Highlight when dragging */
            opacity: 0.8;
        }


        .overlay-widget .widget-header {
            border-bottom: 1px solid var(--tertiary-bg);
            padding-left: 20px;
            padding-right: 20px;
        }
        .overlay-widget .widget-header h3 {
            color: var(--text-color); /* Overlays might have less prominent titles */
        }

        .overlay-widget .widget-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .overlay-widget .widget-actions button.close-overlay-btn {
            color: var(--text-color-light);
            font-size: 1.2em;
        }
        .overlay-widget .widget-actions button.close-overlay-btn:hover {
            color: #dc3545; /* Red for close */
            background-color: rgba(220, 53, 69, 0.1);
        }
        /* Hide fullscreen/overlay buttons on overlay widgets */
        .overlay-widget .fullscreen-btn, .overlay-widget .overlay-btn, .overlay-widget .remove-btn {
            display: none !important; /* Hide all other action buttons on overlay widgets */
        }

        /* Settings Modal */
        #settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--secondary-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 10001; /* Changed from 10001 to ensure it's above message box (10000) */
            display: flex;
            flex-direction: column;
            gap: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed), visibility var(--transition-speed);
            min-width: 300px;
            max-width: 90%;
        }
        #settings-modal.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--tertiary-bg);
        }
        .modal-header h2 {
            font-size: 1.5em;
            color: var(--accent-color);
        }
        .modal-header button {
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--text-color-light);
            cursor: pointer;
            transition: color var(--transition-speed);
        }
        .modal-header button:hover {
            color: #dc3545;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--tertiary-bg);
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        .setting-item label {
            font-size: 1.1em;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .setting-item label i {
            color: var(--accent-color);
        }
        .setting-item input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 50px;
            height: 30px;
            background-color: transparent;
            border: 2px solid var(--border-color);
            cursor: pointer;
            padding: 2px;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        .setting-item input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .setting-item input[type="color"]::-webkit-color-swatch { border: none; border-radius: calc(var(--border-radius) - 2px); }
        .setting-item input[type="color"]::-moz-color-swatch-wrapper { padding: 0; }
        .setting-item input[type="color"]::-moz-color-swatch { border: none; border-radius: calc(var(--border-radius) - 2px); }

        .accent-color-options {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .accent-color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }
        .accent-color-option:hover {
            transform: scale(1.1);
            border-color: var(--accent-color-dark);
        }
        .accent-color-option.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-color);
        }

        .background-image-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .background-image-controls input[type="file"] {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--primary-bg);
            color: var(--text-color);
        }
        .background-image-controls button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .background-image-controls button:hover {
            background-color: var(--accent-color-dark);
        }
        .background-image-controls button:last-child {
            background-color: #dc3545; /* Red for clear */
        }
        .background-image-controls button:last-child:hover {
            background-color: #c82333;
        }

        .reset-button {
            background-color: #dc3545; /* Red for reset */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
            margin-top: 20px;
        }
        .reset-button:hover {
            background-color: #c82333;
        }


        /* Specific Widget Styles (Example - Calculator) */
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            flex-grow: 1;
            padding-top: 10px; /* Space from display */
        }

        .calculator-display {
            background-color: var(--tertiary-bg);
            color: var(--text-color);
            font-size: 2.2em; /* Default, adjusted by JS */
            padding: 10px 15px;
            border-radius: var(--border-radius);
            text-align: right;
            margin-bottom: 10px;
            overflow-x: hidden; /* Hide horizontal overflow */
            white-space: nowrap; /* Prevent wrapping */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex-shrink: 0;
        }

        .calculator-grid button {
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1.5em;
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.15s ease, transform 0.1s ease;
            color: var(--text-color);
        }

        .calculator-grid button:hover {
            background-color: var(--tertiary-bg);
        }

        .calculator-grid button:active {
            transform: scale(0.98);
        }

        .calculator-grid button.operator {
            background-color: var(--accent-color);
            color: white;
        }
        .calculator-grid button.operator:hover {
            background-color: var(--accent-color-dark);
        }
        .calculator-grid button.equal {
            background-color: #28a745;
            color: white;
            grid-column: span 2;
        }
        .calculator-grid button.equal:hover {
            background-color: #218838;
        }
        .calculator-grid button.clear {
            background-color: #dc3545;
            color: white;
        }
        .calculator-grid button.clear:hover {
            background-color: #c82333;
        }

        /* Timer/Stopwatch Styles */
        .timer-display, .stopwatch-display {
            font-size: 4em; /* Default, adjusted by JS */
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-color);
            flex-grow: 1; /* Allow display to grow */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px; /* Added padding */
            overflow: hidden; /* Hide horizontal overflow */
            white-space: nowrap; /* Prevent wrapping */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
        }

        .timer-controls, .stopwatch-controls, .stopwatch-laps {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap; /* Allow controls to wrap */
            flex-shrink: 0; /* Prevent controls from shrinking */
        }

        .timer-controls input {
            flex-grow: 1; /* Allow inputs to grow/shrink */
            max-width: 60px; /* Preferred max width */
            padding: 8px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--primary-bg);
            color: var(--text-color);
            text-align: center;
        }

        .timer-controls button, .stopwatch-controls button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .timer-controls button:hover, .stopwatch-controls button:hover {
            background-color: var(--accent-color-dark);
        }

        .timer-controls button:active, .stopwatch-controls button:active {
            transform: scale(0.98);
        }

        .stopwatch-laps {
            margin-top: 20px;
            flex-direction: column;
            align-items: center;
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
        }
        .stopwatch-laps div {
            width: 80%;
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--tertiary-bg);
            color: var(--text-color-light);
        }
        .stopwatch-laps div:last-child {
            border-bottom: none;
        }

        /* PDF Viewer Specifics */
        .pdf-viewer-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden; /* Ensure no scrollbars from content outside iframe */
        }

        .pdf-viewer-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            background-color: var(--primary-bg); /* Fallback background for iframe */
        }

        .pdf-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-shrink: 0;
            padding: 10px; /* Add padding to input group */
            background-color: var(--tertiary-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .pdf-input-group input[type="file"] {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--secondary-bg);
            color: var(--text-color);
            transition: border-color var(--transition-speed), background-color var(--transition-speed);
        }
        .pdf-input-group input[type="file"]:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .pdf-input-group button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .pdf-input-group button:hover {
            background-color: var(--accent-color-dark);
        }

        /* Calendar Widget */
        .calendar-widget-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: flex-start;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--tertiary-bg);
            flex-shrink: 0;
        }
        .calendar-header button {
            background: none;
            border: none;
            font-size: 1.2em;
            color: var(--accent-color);
            cursor: pointer;
        }
        .calendar-header button:hover {
            color: var(--accent-color-dark);
        }
        .calendar-header h4 {
            font-size: 1.4em;
            color: var(--text-color);
            font-weight: 600;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            flex-grow: 1;
            text-align: center;
        }
        .calendar-grid div {
            padding: 8px 0;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9em;
            color: var(--text-color);
        }
        .calendar-grid .day-name {
            font-weight: 600;
            color: var(--accent-color);
        }
        .calendar-grid .day {
            background-color: var(--tertiary-bg);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .calendar-grid .day:hover:not(.current-day) {
            background-color: color-mix(in srgb, var(--tertiary-bg) 80%, var(--accent-color));
        }
        .calendar-grid .empty {
            background: none;
            cursor: default;
        }
        .calendar-grid .current-day {
            background-color: var(--accent-color);
            color: white;
            font-weight: 700;
            border: 1px solid var(--accent-color-dark);
        }

        /* Grade Calculator */
        .grade-calc-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        .grade-calc-input-group input {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--primary-bg);
            color: var(--text-color);
        }
        .grade-calc-input-group button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .grade-calc-input-group button:hover {
            background-color: var(--accent-color-dark);
        }
        .grade-items {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            margin-bottom: 15px;
        }
        .grade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed var(--tertiary-bg);
        }
        .grade-item:last-child {
            border-bottom: none;
        }
        .grade-item button {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 0.9em;
        }
        .grade-result {
            font-size: 1.5em;
            font-weight: 700;
            text-align: center;
            color: var(--text-color);
            margin-top: 10px;
        }

        /* Dictionary Widget */
        .dictionary-search-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        .dictionary-search-group input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--primary-bg);
            color: var(--text-color);
        }
        .dictionary-search-group button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
        }
        .dictionary-search-group button:hover {
            background-color: var(--accent-color-dark);
        }
        .dictionary-results {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            background-color: var(--primary-bg);
        }
        .dictionary-results h4 {
            color: var(--accent-color);
            margin-bottom: 5px;
        }
        .dictionary-results p {
            margin-bottom: 10px;
            color: var(--text-color-light);
        }

        /* Unit Converter Widget */
        .unit-converter-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
        }
        .unit-converter-controls select,
        .unit-converter-controls input {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--primary-bg);
            color: var(--text-color);
            width: 100%; /* Ensure they take full width */
        }
        .unit-converter-result {
            margin-top: 20px;
            font-size: 1.5em;
            font-weight: 700;
            text-align: center;
            color: var(--text-color);
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Clicker Widget */
        .clicker-display {
            font-size: 4em;
            font-weight: 700;
            text-align: center;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
        }
        .clicker-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-shrink: 0;
        }
        .clicker-controls button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .clicker-controls button:hover {
            background-color: var(--accent-color-dark);
        }

        /* Quote Generator Widget */
        .quote-display {
            font-size: 1.4em;
            font-style: italic;
            text-align: center;
            margin-bottom: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
        }
        .quote-author {
            font-size: 1em;
            margin-top: 10px;
            color: var(--text-color-light);
        }
        .quote-controls {
            text-align: center;
            flex-shrink: 0;
        }
        .quote-controls button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .quote-controls button:hover {
            background-color: var(--accent-color-dark);
        }

        /* To Do List Widget */
        .todo-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        .todo-input-group input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--primary-bg);
            color: var(--text-color);
        }
        .todo-input-group button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
        }
        .todo-input-group button:hover {
            background-color: var(--accent-color-dark);
        }
        .todo-list {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            background-color: var(--primary-bg);
        }
        .todo-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed var(--tertiary-bg);
        }
        .todo-item:last-child {
            border-bottom: none;
        }
        .todo-item input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            transform: scale(1.2);
        }
        .todo-item span {
            flex-grow: 1;
            color: var(--text-color);
        }
        .todo-item.completed span {
            text-decoration: line-through;
            color: var(--text-color-light);
        }
        .todo-item button {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
        }

        /* Notes Widget */
        .notes-textarea {
            width: 100%;
            height: 100%;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--primary-bg);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            font-size: 1em;
            resize: none; /* Allow manual resize if desired, but widget handles it */
            flex-grow: 1;
            line-height: 1.5;
        }
        .notes-textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 1px var(--accent-color);
        }

        /* Pomodoro Timer Widget */
        .pomodoro-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        .pomodoro-controls input {
            flex-grow: 1; /* Allow inputs to grow/shrink */
            max-width: 60px; /* Preferred max width */
            padding: 8px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--primary-bg);
            color: var(--text-color);
            text-align: center;
        }
        .pomodoro-controls button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .pomodoro-controls button:hover {
            background-color: var(--accent-color-dark);
        }
        .pomodoro-display {
            font-size: 4em; /* Default, adjusted by JS */
            font-weight: 700;
            text-align: center;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            overflow: hidden; /* Hide horizontal overflow */
            white-space: nowrap; /* Prevent wrapping */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            padding: 10px; /* Added padding */
        }
        .pomodoro-status {
            text-align: center;
            font-size: 1.2em;
            color: var(--text-color-light);
            margin-top: 10px;
            flex-shrink: 0;
        }

        /* Image Upload Widget */
        .image-upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            gap: 15px;
            border: 1px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            background-color: var(--primary-bg);
            overflow: hidden; /* Important for image scaling */
        }
        .image-upload-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Ensures image fits within bounds */
            border-radius: var(--border-radius);
        }
        .image-upload-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            flex-shrink: 0;
        }
        .image-upload-controls input[type="file"] {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--secondary-bg);
            color: var(--text-color);
            cursor: pointer;
        }
        .image-upload-controls button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .image-upload-controls button:hover {
            background-color: #c82333;
        }


        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--tertiary-bg);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 10px;
            transition: background var(--transition-speed);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color-dark);
        }

        /* Media Queries for Responsiveness */
        @media (max-width: 768px) {
            #widget-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 15px;
                padding: 15px;
            }
            #widget-palette {
                width: 100%;
                max-width: 300px;
            }
            .widget.fullscreen .widget-content {
                padding: 15px;
            }
            #add-widget-fab {
                bottom: 15px;
                right: 15px;
                width: 35px;
                height: 35px;
                font-size: 1.2em;
            }
            #settings-fab {
                bottom: 15px;
                right: 60px; /* Adjusted for smaller FABs */
                width: 35px;
                height: 35px;
                font-size: 1.2em;
            }
        }

        @media (max-width: 480px) {
            #dashboard-main {
                padding: 10px;
            }
            #widget-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .widget.fullscreen .widget-content {
                padding: 10px;
            }
            #add-widget-fab {
                bottom: 10px;
                right: 10px;
                width: 30px;
                height: 30px;
                font-size: 1em;
            }
            #settings-fab {
                bottom: 10px;
                right: 50px; /* Adjusted for smaller FABs */
                width: 30px;
                height: 30px;
                font-size: 1em;
            }
        }

        /* Welcome Screen Styles */
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--primary-bg); /* Matches primary background */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999; /* Ensures it's on top of everything */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }

        #welcome-screen.visible {
            opacity: 1;
            visibility: visible;
        }

        #welcome-screen.fade-out {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-100%); /* Slide up effect */
            transition: opacity 0.7s ease-out, transform 0.7s ease-out, visibility 0.7s ease-out;
        }

        .welcome-box {
            background-color: var(--secondary-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 40px;
            max-width: 500px;
            width: 90%; /* Responsive width */
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px; /* Space between elements */

            /* Initial state for animation */
            opacity: 0;
            transform: scale(0.8);
            animation: fadeInPopUp 1s forwards ease-out;
        }

        /* Removed .welcome-logo styles as per user request */

        .welcome-title {
            font-family: 'Inter', sans-serif; /* Explicitly set font */
            font-size: 2.8em; /* Slightly adjusted */
            font-weight: 700;
            letter-spacing: -0.02em; /* Tighter letter spacing for Apple-like feel */
            color: var(--text-color); /* Title should be main text color, not accent */
            margin: 0;
            opacity: 0; /* Initial state for delayed animation */
            animation: fadeIn 1s forwards ease-out 0.3s; /* Delayed fade-in */
        }

        .welcome-description {
            font-family: 'Inter', sans-serif; /* Explicitly set font */
            font-size: 1.1em; /* Slightly smaller */
            color: var(--text-color-light);
            margin-top: 0; /* Remove extra margin */
            line-height: 1.5;
            opacity: 0;
            animation: fadeIn 1s forwards ease-out 0.6s; /* Further delayed fade-in */
        }

        .get-started-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 30px; /* More padding */
            border-radius: 25px; /* More rounded, pill-like */
            font-size: 1.1em;
            font-weight: 600; /* Bolder */
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 25px; /* Adjusted margin */
            opacity: 0;
            animation: fadeInSlideUp 0.8s forwards ease-out 0.9s; /* New animation */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);

            /* Progress bar specific styles */
            position: relative; /* For absolute positioning of progress bar */
            overflow: hidden; /* Hide overflow of progress bar */
            display: flex;
            justify-content: center;
            align-items: center;
            min-width: 200px; /* Ensure button is wide enough for text and bar */
        }
        .get-started-btn:hover:not(:disabled) { /* Only hover if not disabled */
            background-color: var(--accent-color-dark);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .get-started-btn:active:not(:disabled) { /* Only active if not disabled */
            transform: scale(0.96);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Keep button enabled, so no specific disabled styles are needed here for interaction */
        /* .get-started-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        } */

        .get-started-btn .button-text {
            position: relative;
            z-index: 1; /* Ensure text is above progress bar */
            transition: color 0.2s ease;
        }

        .get-started-btn .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%; /* Initial width */
            background-color: rgba(255, 255, 255, 0.3); /* Semi-transparent white */
            border-radius: 25px; /* Match button border-radius */
            transition: width 0.1s linear; /* Smooth fill */
            z-index: 0;
        }


        /* New Keyframe Animations */
        @keyframes fadeInPopUp {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes fadeInSlideUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Removed bounceIn as logo is removed */

        /* --- New Widget Specific Styles --- */

        /* Number Guessing Game */
        .game-display {
            font-size: 1.8em;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-color);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .game-input {
            width: 100px;
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--primary-bg);
            color: var(--text-color);
            font-size: 1em;
            /* Ensure it doesn't get cut off vertically when contentDiv has overflow: auto */
            box-sizing: border-box; /* Important for padding/border calculation */
            flex-shrink: 0; /* Prevent from shrinking too much */
            max-width: 80%; /* Give some room */
        }
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-shrink: 0;
            padding-top: 10px; /* Add some space from above content */
        }
        .game-controls button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .game-controls button:hover {
            background-color: var(--accent-color-dark);
        }

        /* Formula Book */
        .formula-category-select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--primary-bg);
            color: var(--text-color);
            width: 100%;
            margin-bottom: 15px;
            flex-shrink: 0; /* Prevent from shrinking */
        }
        .formula-list {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            background-color: var(--primary-bg);
        }
        .formula-list h5 {
            color: var(--accent-color);
            margin-bottom: 5px;
            font-size: 1.1em;
            border-bottom: 1px dotted var(--tertiary-bg);
            padding-bottom: 3px;
            margin-top: 10px;
        }
        .formula-list p {
            margin-bottom: 8px;
            line-height: 1.4;
            color: var(--text-color);
        }
        .formula-list span.formula {
            font-family: 'Courier New', Courier, monospace;
            background-color: var(--tertiary-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            color: var(--text-color);
            display: inline-block;
            margin-left: 5px;
        }

        /* Periodic Table */
        .periodic-table-grid {
            display: grid;
            grid-template-columns: repeat(18, minmax(20px, 1fr)); /* Min width for cells, flexible growth */
            gap: 2px;
            flex-grow: 1;
            overflow: auto; /* IMPORTANT: Enables scrollbars for the table itself */
            padding: 5px;
            background-color: var(--primary-bg);
            border-radius: var(--border-radius);
            /* Added min-width/height to ensure content can scroll within */
            min-width: 0; /* Override default min-width of flex items */
            min-height: 0; /* Override default min-height of flex items */
        }

        /* Ensure element cells themselves don't break layout */
        .element-cell {
            background-color: var(--tertiary-bg);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 2px; /* Reduced padding for smaller cells */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.6em; /* Smaller base font size */
            cursor: pointer;
            transition: background-color 0.15s ease, transform 0.1s ease;
            position: relative; /* For tooltip */
            aspect-ratio: 1 / 1; /* Make cells square */
            min-width: 20px; /* Ensure a minimum size */
            min-height: 20px; /* Ensure a minimum size */
            overflow: hidden; /* Hide overflowing text in very small cells */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            white-space: nowrap; /* Prevent wrapping text */
        }
        .element-cell:hover {
            background-color: color-mix(in srgb, var(--tertiary-bg) 80%, var(--accent-color));
            transform: scale(1.05);
            z-index: 2; /* Bring hovered element slightly to front */
        }
        .element-cell .symbol {
            font-size: 1.3em; /* Larger symbol */
            font-weight: 700;
            color: var(--accent-color);
        }
        .element-cell .number {
            font-size: 0.7em; /* Smaller number */
            position: absolute;
            top: 2px;
            left: 2px;
            color: var(--text-color-light);
        }
        .element-cell .mass {
            font-size: 0.5em; /* Smallest mass */
            position: absolute;
            bottom: 2px;
            right: 2px;
            color: var(--text-color-light);
        }
        .element-cell .name { /* Hide name by default, show on hover or for bigger cells */
            display: none;
        }
        /* Show name on hover or in larger contexts (like fullscreen) */
        .element-cell:hover .name {
            display: block; /* Show name on hover */
            font-size: 0.7em;
            margin-top: 2px;
            white-space: normal; /* Allow wrapping for name on hover */
            text-align: center;
        }
        .element-cell.empty-cell {
            background: none;
            border: none;
            cursor: default;
        }

        /* Text Summarizer */
        .summarizer-textarea {
            width: 100%;
            flex-grow: 1; /* Allows it to take available vertical space */
            min-height: 100px; /* Ensure minimum height */
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--primary-bg);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            font-size: 1em;
            resize: vertical; /* Allow user to resize vertically */
            margin-bottom: 15px;
            box-sizing: border-box; /* Include padding/border in width/height */
        }
        .summarizer-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-shrink: 0; /* Prevent from shrinking too much */
            justify-content: center; /* Center buttons */
        }
        .summarizer-controls button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .summarizer-controls button:hover {
            background-color: var(--accent-color-dark);
        }
        .summarizer-output {
            flex-grow: 1; /* Allows it to take available vertical space */
            overflow-y: auto; /* IMPORTANT: Adds scrollbars if content overflows */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            background-color: var(--primary-bg);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 80px; /* Ensure minimum height */
            box-sizing: border-box;
        }
        .summarizer-output p {
            margin-bottom: 10px;
            text-align: justify;
        }
        .summarizer-output p:last-child {
            margin-bottom: 0;
        }

        /* Drawing Board Widget */
        .drawing-board-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            flex-shrink: 0;
            justify-content: center;
            align-items: center;
            padding: 5px; /* Add some padding to controls */
        }
        .drawing-board-controls label {
            color: var(--text-color);
            font-size: 0.9em;
        }
        .drawing-board-controls input[type="color"],
        .drawing-board-controls input[type="range"] {
            vertical-align: middle;
            margin-left: 5px;
        }
        .drawing-board-controls input[type="color"] {
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        .drawing-board-controls input[type="range"] {
            width: 80px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--tertiary-bg);
            border-radius: 5px;
            outline: none;
            height: 8px;
        }
        .drawing-board-controls input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            border: 1px solid var(--accent-color-dark);
        }
        .drawing-board-controls button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .drawing-board-controls button:hover {
            background-color: var(--accent-color-dark);
        }
        .drawing-canvas {
            border: 1px solid var(--border-color);
            background-color: white; /* Canvas background should be white */
            flex-grow: 1; /* Allow canvas to fill remaining space */
            cursor: crosshair;
            display: block; /* Remove extra space below canvas */
        }
        .widget.fullscreen .drawing-canvas {
            width: 100%;
            height: 100%; /* Will be set by JS dynamically */
            border: none; /* No border in fullscreen */
            background-color: white; /* Maintain white background */
        }


        /* Music Widget */
        .music-player-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .music-sound-list {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            background-color: var(--primary-bg);
            margin-bottom: 10px;
        }
        .music-sound-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--tertiary-bg);
        }
        .music-sound-item:last-child {
            border-bottom: none;
        }
        .music-sound-item span {
            flex-grow: 1;
            color: var(--text-color);
            font-weight: 500;
        }
        .music-sound-item .controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .music-sound-item button {
            background: none;
            border: none;
            color: var(--accent-color);
            font-size: 1.1em;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .music-sound-item button:hover {
            color: var(--accent-color-dark);
        }
        .music-sound-item input[type="range"] {
            width: 60px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--tertiary-bg);
            border-radius: 5px;
            outline: none;
            height: 5px;
        }
        .music-sound-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            border: 1px solid var(--accent-color-dark);
        }
    </style>
</head>
<body>
    <div id="welcome-screen">
        <div class="welcome-box">
            <h1 class="welcome-title">Welcome to StudiumOS</h1>
            <p class="welcome-description">Your personalized productivity hub, designed to help you focus and achieve your goals.</p>
            <button class="get-started-btn">
                <span class="button-text">Get Started</span>
                <div class="progress-bar"></div>
            </button>
        </div>
    </div>

    <div id="app-container">
        <main id="dashboard-main">
            <section id="widget-grid">
                </section>
        </main>

        <button id="settings-fab" title="Settings"><i class="fas fa-cog"></i></button>
        <button id="add-widget-fab" title="Add New Widget"><i class="fas fa-plus"></i></button>

        <div id="widget-palette" class="hidden">
            <div class="palette-header">
                <h2>Add Widgets</h2>
                <button id="close-widget-palette-btn"><i class="fas fa-times"></i></button>
            </div>
            <div class="widget-list">
                </div>
        </div>

        <div id="overlay-container" class="hidden">
            </div>

        <div id="settings-modal" class="hidden">
            <div class="modal-header">
                <h2>Settings</h2>
                <button id="close-settings-modal-btn"><i class="fas fa-times"></i></button>
            </div>
            <div class="setting-item">
                <label for="dark-mode-toggle"><i class="fas fa-moon"></i> Dark Mode</label>
                <input type="checkbox" id="dark-mode-toggle">
            </div>
            <div class="setting-item">
                <label><i class="fas fa-palette"></i> Accent Color:</label>
                <div class="accent-color-options">
                    <button class="accent-color-option" style="background-color: #007bff;" data-color="#007bff" title="Default Blue"></button>
                    <button class="accent-color-option" style="background-color: #28a745;" data-color="#28a745" title="Green"></button>
                    <button class="accent-color-option" style="background-color: #6f42c1;" data-color="#6f42c1" title="Purple"></button>
                    <button class="accent-color-option" style="background-color: #dc3545;" data-color="#dc3545" title="Red"></button>
                    <button class="accent-color-option" style="background-color: #fd7e14;" data-color="#fd7e14" title="Orange"></button>
                    <input type="color" id="accent-color-input-modal" value="#007bff">
                </div>
            </div>
            <div class="setting-item">
                <label><i class="fas fa-image"></i> Background Image:</label>
                <div class="background-image-controls">
                    <input type="file" id="background-image-input" accept="image/*">
                    <button id="clear-background-btn">Clear Background</button>
                </div>
            </div>
            
<div class="setting-item">
    <label for="widget-color-picker"><i class="fas fa-fill-drip"></i> Widget Background:</label>
    <input type="color" id="widget-color-picker" value="#ffffff">
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const widgetColorPicker = document.getElementById('widget-color-picker');
    const storedWidgetColor = localStorage.getItem('studiumos_widgetColor') || '#ffffff';
    widgetColorPicker.value = storedWidgetColor;
    applyWidgetColor(storedWidgetColor);

    widgetColorPicker.addEventListener('input', e => {
        const color = e.target.value;
        applyWidgetColor(color);
        localStorage.setItem('studiumos_widgetColor', color);
    });

    function applyWidgetColor(color) {
        const style = document.documentElement;
        style.style.setProperty('--secondary-bg', color);
        // Also override dark mode secondary-bg using a fallback var if needed
        const darkModeStyle = document.querySelector("[data-theme='dark']");
        if (darkModeStyle) {
            darkModeStyle.style.setProperty('--secondary-bg', color);
        }
    }
});
</script>

<button id="reset-all-btn" class="reset-button"><i class="fas fa-undo"></i> Reset All Settings & Widgets</button>
        </div>

    </div>

    <script>
        // JavaScript for StudiumOS Dashboard

        // IIFE for encapsulation
        (function() {
            // --- Configuration & State Variables ---
            const appContainer = document.getElementById('app-container');
            const dashboardMain = document.getElementById('dashboard-main');
            const widgetGrid = document.getElementById('widget-grid');
            const widgetPalette = document.getElementById('widget-palette');
            const widgetPaletteList = widgetPalette.querySelector('.widget-list');
            const overlayContainer = document.getElementById('overlay-container');
            const welcomeScreen = document.getElementById('welcome-screen');
            const getStartedBtn = document.querySelector('.get-started-btn');
            const getStartedBtnText = getStartedBtn.querySelector('.button-text');
            const getStartedProgressBar = getStartedBtn.querySelector('.progress-bar');


            const addWidgetFab = document.getElementById('add-widget-fab');
            const settingsFab = document.getElementById('settings-fab');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsModalBtn = document.getElementById('close-settings-modal-btn');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const accentColorInputModal = document.getElementById('accent-color-input-modal');
            const accentColorOptions = document.querySelectorAll('.accent-color-option');
            const backgroundImageInput = document.getElementById('background-image-input');
            const clearBackgroundBtn = document.getElementById('clear-background-btn');
            const resetAllBtn = document.getElementById('reset-all-btn');

            const closeWidgetPaletteBtn = document.getElementById('close-widget-palette-btn');


            let activeWidgets = {};
            let nextWidgetId = 1;
            let currentFullscreenWidgetId = null;
            let isAddingOverlay = false;
            let welcomeScreenTimeoutId; // This stores the timeout for the *automatic* progress bar
            let progressBarIntervalId; // This stores the interval for the *progress bar animation*


            // Widget Definitions
            const widgetDefinitions = [
                { id: 'timer', name: 'Timer', icon: 'fas fa-hourglass-half', component: createTimerWidget },
                { id: 'stopwatch', name: 'Stopwatch', icon: 'fas fa-stopwatch', component: createStopwatchWidget },
                { id: 'calculator', name: 'Calculator', icon: 'fas fa-calculator', component: createCalculatorWidget },
                { id: 'grade-calculator', name: 'Grade Calculator', icon: 'fas fa-graduation-cap', component: createGradeCalculatorWidget },
                { id: 'calendar', name: 'Calendar', icon: 'fas fa-calendar-alt', component: createCalendarWidget },
                { id: 'pdf-viewer', name: 'PDF Viewer', icon: 'fas fa-file-pdf', component: createPdfViewerWidget },
                { id: 'dictionary', name: 'Dictionary', icon: 'fas fa-book', component: createDictionaryWidget },
                { id: 'unit-converter', name: 'Unit Converter', icon: 'fas fa-exchange-alt', component: createUnitConverterWidget },
                { id: 'clicker', name: 'Clicker', icon: 'fas fa-hand-pointer', component: createClickerWidget },
                { id: 'quote-generator', name: 'Quote Generator', icon: 'fas fa-quote-right', component: createQuoteGeneratorWidget },
                { id: 'todo-list', name: 'To Do List', icon: 'fas fa-tasks', component: createTodoListWidget },
                { id: 'notes', name: 'Notes', icon: 'fas fa-sticky-note', component: createNotesWidget },
                { id: 'pomodoro', name: 'Pomodoro Timer', icon: 'fas fa-hourglass-half', component: createPomodoroTimerWidget },
                { id: 'image-upload', name: 'Image Upload', icon: 'fas fa-image', component: createImageUploadWidget },
                { id: 'game-guessing', name: 'Number Guessing Game', icon: 'fas fa-gamepad', component: createNumberGuessingGameWidget },
                { id: 'formula-book', name: 'Formula Book', icon: 'fas fa-book-open', component: createFormulaBookWidget },
                { id: 'periodic-table', name: 'Periodic Table', icon: 'fas fa-atom', component: createPeriodicTableWidget },
                { id: 'text-summarizer', name: 'Text Summarizer', icon: 'fas fa-compress-alt', component: createTextSummarizerWidget },
                { id: 'drawing-board', name: 'Drawing Board', icon: 'fas fa-paint-brush', component: createDrawingBoardWidget },
                { id: 'music-player', name: 'Music Player', icon: 'fas fa-music', component: createMusicPlayerWidget },
            ];

            // --- Utility Functions ---

            /**
             * Helper to format time for display.
             * @param {number} totalSeconds
             * @returns {string}
             */
            function formatTime(totalSeconds) {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                return [hours, minutes, seconds]
                    .map(v => v < 10 ? '0' + v : v)
                    .filter((v, i) => v !== '00' || i > 0 || (i === 0 && (hours > 0 || minutes > 0 || seconds > 0)))
                    .join(':') || '00:00';
            }

            /**
             * Saves a setting to local storage.
             * @param {string} key
             * @param {any} value
             */
            function saveSetting(key, value) {
                localStorage.setItem(`studiumos_${key}`, JSON.stringify(value));
            }

            /**
             * Loads a setting from local storage.
             * @param {string} key
             * @param {any} defaultValue
             * @returns {any}
             */
            function loadSetting(key, defaultValue) {
                const storedValue = localStorage.getItem(`studiumos_${key}`);
                return storedValue ? JSON.parse(storedValue) : defaultValue;
            }

            /**
             * Displays a custom message box instead of browser alert/confirm.
             * @param {string} message The message to display.
             * @param {function} [onConfirm] Callback for 'OK' button.
             */
            function showMessageBox(message, onConfirm = null) {
                const messageBox = document.createElement('div');
                messageBox.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background-color: var(--secondary-bg); padding: 20px; border-radius: var(--border-radius);
                    box-shadow: var(--shadow); z-index: 10002; text-align: center;
                    color: var(--text-color); display: flex; flex-direction: column; gap: 15px;
                    max-width: 90%;
                `;
                messageBox.innerHTML = `
                    <p style="font-size: 1.2em;">${message}</p>
                    <button class="message-box-ok-btn" style="background-color: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease;">OK</button>
                `;
                document.body.appendChild(messageBox);

                const okBtn = messageBox.querySelector('.message-box-ok-btn');
                okBtn.addEventListener('click', () => {
                    messageBox.remove();
                    if (onConfirm) onConfirm();
                });
                okBtn.addEventListener('mouseover', () => okBtn.style.backgroundColor = 'var(--accent-color-dark)');
                okBtn.addEventListener('mouseout', () => okBtn.style.backgroundColor = 'var(--accent-color)');
            }


            // --- Theming Logic ---

            /**
             * Applies the selected theme (dark/light).
             * @param {string} theme 'dark' or 'light'
             */
            function applyTheme(theme) {
                appContainer.setAttribute('data-theme', theme);
                darkModeToggle.checked = (theme === 'dark');
                saveSetting('theme', theme);
            }

            /**
             * Applies the selected accent color.
             * @param {string} color Hex color code
             */
            function applyAccentColor(color) {
                appContainer.style.setProperty('--dynamic-accent-color', color);
                appContainer.setAttribute('data-accent-color', color);
                accentColorInputModal.value = color;

                accentColorOptions.forEach(btn => {
                    if (btn.dataset.color === color) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });

                saveSetting('accentColor', color);
            }

            /**
             * Applies a background image to the body.
             * @param {string} imageUrl Data URL or external URL of the image.
             */
            function applyBackgroundImage(imageUrl) {
                document.body.style.backgroundImage = `url('${imageUrl}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
                document.body.style.backgroundColor = 'transparent'; // Ensure body background is transparent
                appContainer.style.backgroundColor = 'transparent'; // Ensure app container is transparent
                saveSetting('backgroundImage', imageUrl);
            }

            /**
             * Clears the background image from the body.
             */
            function clearBackgroundImage() {
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundSize = '';
                document.body.style.backgroundPosition = '';
                document.body.style.backgroundAttachment = '';
                // Revert background colors to CSS defaults (which will be var(--primary-bg))
                document.body.style.backgroundColor = '';
                appContainer.style.backgroundColor = '';
                localStorage.removeItem('studiumos_backgroundImage');
            }


            // --- UI Event Handlers ---

            // Settings Modal Controls
            settingsFab.addEventListener('click', () => {
                settingsModal.classList.add('visible');
            });

            closeSettingsModalBtn.addEventListener('click', () => {
                settingsModal.classList.remove('visible');
            });

            darkModeToggle.addEventListener('change', (event) => {
                applyTheme(event.target.checked ? 'dark' : 'light');
            });

            accentColorInputModal.addEventListener('input', (event) => {
                applyAccentColor(event.target.value);
            });

            // Accent color swatch buttons
            accentColorOptions.forEach(button => {
                button.addEventListener('click', () => {
                    applyAccentColor(button.dataset.color);
                });
            });

            // Background image controls
            backgroundImageInput.addEventListener('change', () => {
                const file = backgroundImageInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        applyBackgroundImage(e.target.result);
                    };
                    reader.readAsDataURL(file);
                } else {
                    showMessageBox('Please select an image file to apply as background.');
                }
            });

            clearBackgroundBtn.addEventListener('click', () => {
                clearBackgroundImage();
            });

            // Reset All button
            resetAllBtn.addEventListener('click', () => {
        localStorage.removeItem('studiumos_widgetColor');
        document.documentElement.style.removeProperty('--secondary-bg');
        document.querySelector("[data-theme='dark']")?.style.removeProperty('--secondary-bg');
        const picker = document.getElementById('widget-color-picker');
        if (picker) picker.value = '#ffffff';
                showMessageBox('Are you sure you want to reset all settings and remove all widgets? This cannot be undone.', () => {
                    resetAllSettingsAndWidgets();
                });
            });


            // FAB for Add Widgets
            addWidgetFab.addEventListener('click', () => {
                isAddingOverlay = false;
                widgetPalette.classList.add('visible');
            });

            closeWidgetPaletteBtn.addEventListener('click', () => {
                widgetPalette.classList.remove('visible');
            });

            // --- Widget Management Functions ---

            /**
             * Creates the common structure for any widget.
             * @param {string} id Unique ID for the widget type.
             * @param {string} name Display name for the widget.
             * @param {HTMLElement} parentElement The parent element to append the widget to.
             * @param {boolean} isOverlay Boolean indicating if it's an overlay widget.
             * @returns {HTMLElement} The created widget element.
             */
            function createWidgetBase(id, name, parentElement, isOverlay = false) {
                const widgetId = `widget-${id}-${nextWidgetId++}`;
                const widgetDiv = document.createElement('div');
                widgetDiv.classList.add('widget');
                widgetDiv.setAttribute('data-widget-id', widgetId);
                widgetDiv.setAttribute('data-widget-type', id);

                let initialWidth = 300;
                let initialHeight = 250;

                // Specific initial dimensions for certain widgets
                if (id === 'calculator') {
                    initialWidth = 350; // A bit wider to accommodate more buttons
                    initialHeight = 450; // Taller for more rows
                } else if (id === 'grade-calculator') {
                    initialWidth = 380;
                    initialHeight = 400;
                } else if (id === 'unit-converter') {
                    initialWidth = 350;
                    initialHeight = 350;
                } else if (id === 'calendar') {
                    initialWidth = 350;
                    initialHeight = 420;
                } else if (id === 'periodic-table') {
                    initialWidth = 800; // Wider to fit more columns
                    initialHeight = 600; // Taller for more rows
                } else if (id === 'text-summarizer' || id === 'formula-book' || id === 'game-guessing' || id === 'drawing-board' || id === 'music-player') {
                    initialWidth = 400; // A bit larger for text/game/drawing/music
                    initialHeight = 450; // More height for content
                }


                const parentRect = parentElement.getBoundingClientRect();
                const padding = 20;
                let initialX = Math.random() * (parentRect.width - initialWidth - padding * 2) + padding;
                let initialY = Math.random() * (parentRect.height - initialHeight - padding * 2) + padding;

                initialX = Math.max(0, Math.min(initialX, parentRect.width - initialWidth));
                initialY = Math.max(0, Math.min(initialY, parentRect.height - initialHeight));


                widgetDiv.style.width = `${initialWidth}px`;
                widgetDiv.style.height = `${initialHeight}px`;
                widgetDiv.style.left = `${initialX}px`;
                widgetDiv.style.top = `${initialY}px`;

                // Add icon based on widget type
                const widgetDefinition = widgetDefinitions.find(def => def.id === id);
                const iconHtml = widgetDefinition && widgetDefinition.icon ? `<i class="${widgetDefinition.icon}" style="margin-right: 8px; color: var(--text-color-light);"></i>` : '';


                widgetDiv.innerHTML = `
                    <div class="widget-header">
                        <h3>${iconHtml}${name}</h3>
                        <div class="widget-actions">
                            <button class="fullscreen-btn" title="Toggle Fullscreen"><i class="fas fa-expand"></i></button>
                            <button class="overlay-btn" title="Add Overlay Widget"><i class="fas fa-layer-group"></i></button>
                            <button class="remove-btn" title="Remove Widget"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="widget-content"></div>
                    <div class="widget-resizer resizer-br"></div>
                    <div class="widget-resizer resizer-bl"></div>
                    <div class="widget-resizer resizer-tr"></div>
                    <div class="widget-resizer resizer-tl"></div>
                    <div class="widget-resizer resizer-b"></div>
                    <div class="widget-resizer resizer-t"></div>
                    <div class="widget-resizer resizer-l"></div>
                    <div class="widget-resizer resizer-r"></div>
                `;

                parentElement.appendChild(widgetDiv);

                // Attach event listeners to buttons and stop propagation
                const removeBtn = widgetDiv.querySelector('.remove-btn');
                const fullscreenBtn = widgetDiv.querySelector('.fullscreen-btn');
                const overlayBtn = widgetDiv.querySelector('.overlay-btn');

                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent drag
                    removeWidget(widgetId);
                });
                fullscreenBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent drag
                    toggleFullscreen(widgetId);
                });

                overlayBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent drag
                    if (widgetDiv.classList.contains('fullscreen')) {
                        isAddingOverlay = true;
                        widgetPalette.classList.add('visible');
                    } else {
                        showMessageBox("This button only works when the widget is in fullscreen mode.");
                    }
                });

                return widgetDiv;
            }

            /**
             * Adds a widget to the dashboard or overlay container based on fullscreen state.
             * @param {string} widgetType - The ID of the widget type.
             */
            function addWidget(widgetType) {
                const definition = widgetDefinitions.find(def => def.id === widgetType);
                if (!definition) {
                    console.error('Unknown widget type:', widgetType);
                    return;
                }

                let targetParent = widgetGrid;
                let isCurrentAdditionOverlay = false;

                if (isAddingOverlay && currentFullscreenWidgetId) {
                    targetParent = overlayContainer;
                    isCurrentAdditionOverlay = true;
                    overlayContainer.classList.add('visible');
                }

                const widgetElement = createWidgetBase(definition.id, definition.name, targetParent, isCurrentAdditionOverlay);
                const widgetContentDiv = widgetElement.querySelector('.widget-content');

                if (isCurrentAdditionOverlay) {
                    widgetElement.classList.add('overlay-widget');
                    widgetElement.classList.remove('widget'); // Remove base widget class

                    // Remove all existing action buttons, then add only the close-overlay-btn
                    const headerActions = widgetElement.querySelector('.widget-actions');
                    headerActions.innerHTML = ''; // Clear all buttons

                    const closeOverlayBtn = document.createElement('button');
                    closeOverlayBtn.classList.add('close-overlay-btn');
                    closeOverlayBtn.title = "Close Overlay";
                    closeOverlayBtn.innerHTML = '<i class="fas fa-times"></i>';
                    headerActions.appendChild(closeOverlayBtn);
                    closeOverlayBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent drag
                        if (widgetElement._overlayInstance && typeof widgetElement._overlayInstance.destroy === 'function') {
                            widgetElement._overlayInstance.destroy();
                        }
                        widgetElement.remove();
                        if (overlayContainer.children.length === 0) {
                            overlayContainer.classList.remove('visible');
                        }
                    });
                }

                const widgetInstance = definition.component(widgetContentDiv, widgetElement.getAttribute('data-widget-id'));
                activeWidgets[widgetElement.getAttribute('data-widget-id')] = {
                    element: widgetElement,
                    instance: widgetInstance
                };

                initDragAndResize(widgetElement);
                widgetPalette.classList.remove('visible');
                isAddingOverlay = false;
            }

            /**
             * Removes a widget from the dashboard.
             * @param {string} widgetId
             */
            function removeWidget(widgetId) {
                const widget = activeWidgets[widgetId];
                if (widget) {
                    if (widget.instance && typeof widget.instance.destroy === 'function') {
                        widget.instance.destroy();
                    }
                    widget.element.remove();
                    delete activeWidgets[widgetId];

                    if (currentFullscreenWidgetId === widgetId) {
                        currentFullscreenWidgetId = null;
                        if (overlayContainer.children.length === 0) {
                            overlayContainer.classList.remove('visible');
                        }
                    }
                    if (widget.element.classList.contains('overlay-widget') && overlayContainer.children.length === 0) {
                        overlayContainer.classList.remove('visible');
                    }
                }
            }

            /**
             * Toggles a widget to fullscreen mode.
             * @param {string} widgetId
             */
            function toggleFullscreen(widgetId) {
                const widget = activeWidgets[widgetId];
                if (widget) {
                    if (widget.element.getAttribute('data-widget-type') === 'drawing-board') {
                        showMessageBox("Fullscreen mode is unavailable for the drawing board widget.");
                        return; // Prevent fullscreen for drawing board
                    }

                    const isFullscreen = widget.element.classList.toggle('fullscreen');
                    if (isFullscreen) {
                        if (currentFullscreenWidgetId && currentFullscreenWidgetId !== widgetId) {
                            toggleFullscreen(currentFullscreenWidgetId);
                        }
                        currentFullscreenWidgetId = widgetId;

                        widget.originalState = {
                            width: widget.element.style.width,
                            height: widget.element.style.height,
                            left: widget.element.style.left,
                            top: widget.element.style.top,
                            zIndex: widget.element.style.zIndex || ''
                        };
                        widget.element.style.zIndex = 1000;
                        widget.element.style.removeProperty('width');
                        widget.element.style.removeProperty('height');
                        widget.element.style.removeProperty('left');
                        widget.element.style.removeProperty('top');
                    } else {
                        currentFullscreenWidgetId = null;
                        if (widget.originalState) {
                            widget.element.style.width = widget.originalState.width;
                            widget.element.style.height = widget.originalState.height;
                            widget.element.style.left = widget.originalState.left;
                            widget.element.style.top = widget.originalState.top;
                            widget.element.style.zIndex = widget.originalState.zIndex;
                            delete widget.originalState;
                        }
                        if (overlayContainer.children.length === 0) {
                            overlayContainer.classList.remove('visible');
                        }
                    }
                    // Call onResize for the widget's internal component
                    // This is crucial for widgets like periodic table or calculator to re-adjust their internal layout/font-sizes
                    if (widget.instance && typeof widget.instance.onResize === 'function') {
                        widget.instance.onResize();
                    }
                }
            }

            /**
             * Initializes draggable and resizable functionality for a widget.
             * @param {HTMLElement} widgetElement
             */
            function initDragAndResize(widgetElement) {
                let isDragging = false;
                let isResizing = false;
                let activeResizer = null;
                let initialX, initialY, initialWidth, initialHeight, initialMouseX, initialMouseY;
                let originalTransition = ''; // To store the element's original transition style

                const widgetHeader = widgetElement.querySelector('.widget-header');
                const resizers = widgetElement.querySelectorAll('.widget-resizer');

                const startInteraction = (e) => {
                    // Prevent interaction if fullscreen (main dashboard widgets) and not an overlay
                    if (widgetElement.classList.contains('fullscreen') && !widgetElement.classList.contains('overlay-widget')) return;
                    // This check is redundant if stopPropagation is used on buttons, but good for safety
                    if (e.target.closest('.widget-actions')) return;

                    e.preventDefault(); // Prevent default browser drag behavior (e.g., image dragging)
                    e.stopPropagation(); // Stop propagation to prevent parent elements from also handling

                    // Store original transition and disable it for smooth movement
                    originalTransition = widgetElement.style.transition;
                    widgetElement.style.transition = 'none';

                    widgetElement.classList.add('dragging'); // Add dragging class for visual feedback

                    initialMouseX = e.clientX;
                    initialMouseY = e.clientY;
                    initialX = widgetElement.offsetLeft; // Position relative to offsetParent
                    initialY = widgetElement.offsetTop;   // Position relative to offsetParent
                    initialWidth = widgetElement.offsetWidth;
                    initialHeight = widgetElement.offsetHeight;

                    // Bring to front while dragging/resizing
                    if (widgetElement.classList.contains('overlay-widget')) {
                        let maxZIndex = 1005; // Base z-index for overlay-container
                        overlayContainer.querySelectorAll('.overlay-widget').forEach(ow => {
                            const z = parseInt(window.getComputedStyle(ow).zIndex);
                            if (!isNaN(z) && z > maxZIndex) maxZIndex = z;
                        });
                        widgetElement.style.zIndex = maxZIndex + 1;
                    } else {
                        widgetElement.style.zIndex = 101;
                    }
                };

                widgetHeader.addEventListener('mousedown', (e) => {
                    // Only start drag if the click is not on an action button
                    if (!e.target.closest('.widget-actions')) {
                        isDragging = true;
                        startInteraction(e);
                    }
                });

                resizers.forEach(resizer => {
                    resizer.addEventListener('mousedown', (e) => {
                        isResizing = true;
                        activeResizer = resizer.classList[1]; // e.g., 'resizer-br'
                        startInteraction(e);
                    });
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        const dx = e.clientX - initialMouseX;
                        const dy = e.clientY - initialMouseY;

                        let newX = initialX + dx;
                        let newY = initialY + dy;

                        // Get parent dimensions relative to its content area
                        const parentElement = widgetElement.parentElement;
                        const parentWidth = parentElement.offsetWidth;
                        const parentHeight = parentElement.offsetHeight;
                        const widgetWidth = widgetElement.offsetWidth;
                        const widgetHeight = widgetElement.offsetHeight;

                        // Constrain newX and newY within parent bounds
                        newX = Math.max(0, Math.min(newX, parentWidth - widgetWidth));
                        newY = Math.max(0, Math.min(newY, parentHeight - widgetHeight));

                        widgetElement.style.left = `${newX}px`;
                        widgetElement.style.top = `${newY}px`;
                    } else if (isResizing) {
                        const dx = e.clientX - initialMouseX;
                        const dy = e.clientY - initialMouseY;

                        let newWidth = initialWidth;
                        let newHeight = initialHeight;
                        let newX = initialX;
                        let newY = initialY;

                        // Minimum dimensions
                        const minWidth = 250;
                        const minHeight = 200;

                        // Get parent dimensions for boundary checks
                        const parentElement = widgetElement.parentElement;
                        const parentWidth = parentElement.offsetWidth;
                        const parentHeight = parentElement.offsetHeight;

                        switch (activeResizer) {
                            case 'resizer-br':
                                newWidth = Math.max(minWidth, initialWidth + dx);
                                newHeight = Math.max(minHeight, initialHeight + dy);
                                break;
                            case 'resizer-bl':
                                newWidth = Math.max(minWidth, initialWidth - dx);
                                newHeight = Math.max(minHeight, initialHeight + dy);
                                newX = initialX + initialWidth - newWidth;
                                break;
                            case 'resizer-tr':
                                newWidth = Math.max(minWidth, initialWidth + dx);
                                newHeight = Math.max(minHeight, initialHeight - dy);
                                newY = initialY + initialHeight - newHeight;
                                break;
                            case 'resizer-tl':
                                newWidth = Math.max(minWidth, initialWidth - dx);
                                newHeight = Math.max(minHeight, initialHeight - dy);
                                newX = initialX + initialWidth - newWidth;
                                newY = initialY + initialHeight - newHeight;
                                break;
                            case 'resizer-b':
                                newHeight = Math.max(minHeight, initialHeight + dy);
                                break;
                            case 'resizer-t':
                                newHeight = Math.max(minHeight, initialHeight - dy);
                                newY = initialY + initialHeight - newHeight;
                                break;
                            case 'resizer-l':
                                newWidth = Math.max(minWidth, initialWidth - dx);
                                newX = initialX + initialWidth - newWidth;
                                break;
                            case 'resizer-r':
                                newWidth = Math.max(minWidth, initialWidth + dx);
                                break;
                        }

                        // Apply boundary checks for new position and size
                        newX = Math.max(0, newX);
                        newY = Math.max(0, newY);
                        newWidth = Math.min(newWidth, parentWidth - newX);
                        newHeight = Math.min(newHeight, parentHeight - newY);

                        widgetElement.style.width = `${newWidth}px`;
                        widgetElement.style.height = `${newHeight}px`;
                        widgetElement.style.left = `${newX}px`;
                        widgetElement.style.top = `${newY}px`;

                        // IMPORTANT: Notify the widget's internal component of a resize
                        const widgetInstance = activeWidgets[widgetElement.getAttribute('data-widget-id')]?.instance || widgetElement._overlayInstance;
                        if (widgetInstance && typeof widgetInstance.onResize === 'function') {
                            widgetInstance.onResize();
                        }
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging || isResizing) {
                        isDragging = false;
                        isResizing = false;
                        activeResizer = null;
                        widgetElement.classList.remove('dragging');
                        widgetElement.style.transition = originalTransition; // Restore original transition

                        // Reset z-index after dragging/resizing if not fullscreen
                        if (!widgetElement.classList.contains('fullscreen') && !widgetElement.classList.contains('overlay-widget')) {
                             widgetElement.style.zIndex = ''; // Revert to CSS default or saved z-index
                        } else if (widgetElement.classList.contains('overlay-widget')) {
                            // For overlays, reset to a default high z-index, but not necessarily the highest
                            widgetElement.style.zIndex = 1006; // A default z-index for overlays, higher than overlay container
                        }
                    }
                });
            }

            // --- Populate Widget Palette ---
            function populateWidgetPalette() {
                widgetPaletteList.innerHTML = ''; // Clear previous options
                widgetDefinitions.forEach(def => {
                    const optionDiv = document.createElement('div');
                    optionDiv.classList.add('widget-option');
                    optionDiv.setAttribute('data-widget-type', def.id);
                    optionDiv.innerHTML = `<i class="${def.icon}"></i> <span>${def.name}</span>`;
                    optionDiv.addEventListener('click', () => addWidget(def.id)); // Call addWidget
                    widgetPaletteList.appendChild(optionDiv);
                });
            }

            // --- Reset Functionality ---
            function resetAllSettingsAndWidgets() {
                // Clear all local storage items starting with 'studiumos_'
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('studiumos_')) {
                        localStorage.removeItem(key);
                    }
                });

                // Remove all widgets from the DOM and activeWidgets object
                for (const widgetId in activeWidgets) {
                    const widget = activeWidgets[widgetId];
                    if (widget.instance && typeof widget.instance.destroy === 'function') {
                        widget.instance.destroy(); // Call destroy method if available
                    }
                    widget.element.remove();
                }
                activeWidgets = {};
                nextWidgetId = 1; // Reset widget ID counter

                // Reset theme, accent color, and background image to defaults
                applyTheme('light');
                applyAccentColor('#007bff');
                clearBackgroundImage();

                // Close any open modals/palettes
                settingsModal.classList.remove('visible');
                widgetPalette.classList.remove('visible');
                overlayContainer.classList.remove('visible'); // Ensure overlay is hidden

                // Re-initialize the app to reflect default state
                populateWidgetPalette();
                showMessageBox('All settings and widgets have been reset to default.');
            }


            // --- Widget Component Functions ---

            /**
             * Timer Widget
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createTimerWidget(contentDiv, widgetId) {
                let timerInterval;
                let totalSeconds = 0;
                let isRunning = false;

                contentDiv.innerHTML = `
                    <div class="timer-display">00:00</div>
                    <div class="timer-controls">
                        <input type="number" min="0" max="99" placeholder="H" class="timer-input-h">
                        <input type="number" min="0" max="59" placeholder="M" class="timer-input-m">
                        <input type="number" min="0" max="59" placeholder="S" class="timer-input-s">
                        <button class="set-btn">Set</button>
                        <button class="start-pause-btn">Start</button>
                        <button class="reset-btn">Reset</button>
                    </div>
                `;

                const display = contentDiv.querySelector('.timer-display');
                const inputH = contentDiv.querySelector('.timer-input-h');
                const inputM = contentDiv.querySelector('.timer-input-m');
                const inputS = contentDiv.querySelector('.timer-input-s');
                const setBtn = contentDiv.querySelector('.set-btn');
                const startPauseBtn = contentDiv.querySelector('.start-pause-btn');
                const resetBtn = contentDiv.querySelector('.reset-btn');

                // Apply flexible styling to inputs
                inputH.style.cssText = `flex-grow: 1; max-width: 60px; padding: 8px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--primary-bg); color: var(--text-color); text-align: center;`;
                inputM.style.cssText = `flex-grow: 1; max-width: 60px; padding: 8px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--primary-bg); color: var(--text-color); text-align: center;`;
                inputS.style.cssText = `flex-grow: 1; max-width: 60px; padding: 8px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--primary-bg); color: var(--text-color); text-align: center;`;


                function updateDisplay() {
                    display.textContent = formatTime(totalSeconds);
                    if (totalSeconds <= 0 && isRunning) {
                        clearInterval(timerInterval);
                        isRunning = false;
                        startPauseBtn.textContent = 'Start';
                        display.textContent = '00:00';
                        showMessageBox('Timer Finished!');
                    }
                }

                function startTimer() {
                    if (!isRunning && totalSeconds > 0) {
                        isRunning = true;
                        startPauseBtn.textContent = 'Pause';
                        timerInterval = setInterval(() => {
                            totalSeconds--;
                            updateDisplay();
                        }, 1000);
                    }
                }

                function pauseTimer() {
                    if (isRunning) {
                        isRunning = false;
                        startPauseBtn.textContent = 'Start';
                        clearInterval(timerInterval);
                    }
                }

                setBtn.addEventListener('click', () => {
                    pauseTimer();
                    const hours = parseInt(inputH.value) || 0;
                    const minutes = parseInt(inputM.value) || 0;
                    const seconds = parseInt(inputS.value) || 0;
                    totalSeconds = (hours * 3600) + (minutes * 60) + seconds;
                    updateDisplay();
                });

                startPauseBtn.addEventListener('click', () => {
                    if (isRunning) {
                        pauseTimer();
                    } else {
                        startTimer();
                    }
                });

                resetBtn.addEventListener('click', () => {
                    pauseTimer();
                    totalSeconds = 0;
                    inputH.value = '';
                    inputM.value = '';
                    inputS.value = '';
                    updateDisplay();
                });

                // Initial display update
                updateDisplay();

                function adjustDisplayFontSize() {
                    const widgetElement = display.closest('.widget'); // Get the parent widget element
                    const currentHeight = display.offsetHeight;
                    const currentWidth = display.offsetWidth;

                    if (widgetElement && widgetElement.classList.contains('fullscreen')) {
                        // Fullscreen mode: set a consistently large size
                        display.style.fontSize = '8em'; // Large fixed size for fullscreen
                    } else {
                        // Regular mode: scale based on available space
                        const sizeBasedOnHeight = currentHeight / 3; // Roughly 1/3 of height
                        const sizeBasedOnWidth = currentWidth / 6; // Roughly 1/6 of width for 00:00:00
                        display.style.fontSize = `${Math.min(sizeBasedOnHeight, sizeBasedOnWidth)}px`;
                    }
                }

                // Call onResize initially and whenever widget is resized
                adjustDisplayFontSize();

                return {
                    destroy: () => {
                        clearInterval(timerInterval);
                    },
                    onResize: adjustDisplayFontSize
                };
            }

            /**
             * Stopwatch Widget
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createStopwatchWidget(contentDiv, widgetId) {
                let stopwatchInterval;
                let elapsedMilliseconds = 0;
                let isRunning = false;
                let lapCounter = 1;
                let laps = [];

                contentDiv.innerHTML = `
                    <div class="stopwatch-display">00:00:00</div>
                    <div class="stopwatch-controls">
                        <button class="start-stop-btn">Start</button>
                        <button class="lap-reset-btn">Lap</button>
                    </div>
                    <div class="stopwatch-laps"></div>
                `;

                const display = contentDiv.querySelector('.stopwatch-display');
                const startStopBtn = contentDiv.querySelector('.start-stop-btn');
                const lapResetBtn = contentDiv.querySelector('.lap-reset-btn');
                const lapsContainer = contentDiv.querySelector('.stopwatch-laps');

                function formatStopwatchTime(ms) {
                    const hours = Math.floor(ms / 3600000);
                    const minutes = Math.floor((ms % 3600000) / 60000);
                    const seconds = Math.floor((ms % 60000) / 1000);
                    const milliseconds = Math.floor((ms % 1000) / 10); // Display 2 digits

                    return [hours, minutes, seconds]
                        .map(v => v < 10 ? '0' + v : v)
                        .join(':') + `.${milliseconds < 10 ? '0' + milliseconds : milliseconds}`;
                }

                function updateDisplay() {
                    display.textContent = formatStopwatchTime(elapsedMilliseconds);
                }

                function startStopwatch() {
                    if (!isRunning) {
                        isRunning = true;
                        startStopBtn.textContent = 'Stop';
                        lapResetBtn.textContent = 'Lap';
                        stopwatchInterval = setInterval(() => {
                            elapsedMilliseconds += 10; // Update every 10ms for smoother millisec display
                            updateDisplay();
                        }, 10);
                    }
                }

                function stopStopwatch() {
                    if (isRunning) {
                        isRunning = false;
                        startStopBtn.textContent = 'Start';
                        lapResetBtn.textContent = 'Reset';
                        clearInterval(stopwatchInterval);
                    }
                }

                function resetStopwatch() {
                    stopStopwatch();
                    elapsedMilliseconds = 0;
                    laps = [];
                    lapCounter = 1;
                    lapsContainer.innerHTML = '';
                    updateDisplay();
                }

                function recordLap() {
                    const lapTime = formatStopwatchTime(elapsedMilliseconds);
                    const lapDiv = document.createElement('div');
                    lapDiv.innerHTML = `<span>Lap ${lapCounter++}:</span> <span>${lapTime}</span>`;
                    lapsContainer.prepend(lapDiv); // Add to top
                }

                startStopBtn.addEventListener('click', () => {
                    if (isRunning) {
                        stopStopwatch();
                    } else {
                        startStopwatch();
                    }
                });

                lapResetBtn.addEventListener('click', () => {
                    if (isRunning) {
                        recordLap();
                    } else {
                        resetStopwatch();
                    }
                });

                // Initial display update
                updateDisplay();

                function adjustDisplayFontSize() {
                    const widgetElement = display.closest('.widget'); // Get the parent widget element
                    const currentHeight = display.offsetHeight;
                    const currentWidth = display.offsetWidth;

                    if (widgetElement && widgetElement.classList.contains('fullscreen')) {
                        // Fullscreen mode: set a consistently large size
                        display.style.fontSize = '8em'; // Large fixed size for fullscreen
                    } else {
                        // Regular mode: scale based on available space
                        const sizeBasedOnHeight = currentHeight / 3; // Roughly 1/3 of height
                        const sizeBasedOnWidth = currentWidth / 8; // Roughly 1/8 of width for 00:00:00.00
                        display.style.fontSize = `${Math.min(sizeBasedOnHeight, sizeBasedOnWidth)}px`;
                    }
                }

                // Call onResize initially and whenever widget is resized
                adjustDisplayFontSize();

                return {
                    destroy: () => {
                        clearInterval(stopwatchInterval);
                    },
                    onResize: adjustDisplayFontSize
                };
            }

            /**
             * Scientific Calculator Widget
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createCalculatorWidget(contentDiv, widgetId) {
                let displayValue = '0';
                let firstOperand = null;
                let operator = null;
                let waitingForSecondOperand = false;

                contentDiv.innerHTML = `
                    <div class="calculator-display">0</div>
                    <div class="calculator-grid">
                        <button class="clear">AC</button>
                        <button class="operator" data-operator="neg">+/-</button>
                        <button class="operator" data-operator="%">%</button>
                        <button class="operator" data-operator="/"></button>

                        <button>7</button>
                        <button>8</button>
                        <button>9</button>
                        <button class="operator" data-operator="*"></button>

                        <button>4</button>
                        <button>5</button>
                        <button>6</button>
                        <button class="operator" data-operator="-">-</button>

                        <button>1</button>
                        <button>2</button>
                        <button>3</button>
                        <button class="operator" data-operator="+">+</button>

                        <button class="zero-btn">0</button>
                        <button class="decimal">.</button>
                        <button class="equal">=</button>

                        <button class="operator" data-operator="sin">sin</button>
                        <button class="operator" data-operator="cos">cos</button>
                        <button class="operator" data-operator="tan">tan</button>
                        <button class="operator" data-operator="log">log</button>
                        <button class="operator" data-operator="sqrt"></button>
                        <button class="operator" data-operator="pow2">x</button>
                        <button class="operator" data-operator="pi"></button>
                        <button class="operator" data-operator="e">e</button>
                    </div>
                `;

                const display = contentDiv.querySelector('.calculator-display');
                const buttons = contentDiv.querySelectorAll('.calculator-grid button');

                function updateDisplay() {
                    display.textContent = displayValue;
                }

                function inputDigit(digit) {
                    if (waitingForSecondOperand) {
                        displayValue = digit;
                        waitingForSecondOperand = false;
                    } else {
                        displayValue = displayValue === '0' ? digit : displayValue + digit;
                    }
                    updateDisplay();
                }

                function inputDecimal(dot) {
                    if (waitingForSecondOperand) {
                        displayValue = '0.';
                        waitingForSecondOperand = false;
                        updateDisplay();
                        return;
                    }
                    if (!displayValue.includes(dot)) {
                        displayValue += dot;
                    }
                    updateDisplay();
                }

                function clearCalculator() {
                    displayValue = '0';
                    firstOperand = null;
                    operator = null;
                    waitingForSecondOperand = false;
                    updateDisplay();
                }

                function handleOperator(nextOperator) {
                    const inputValue = parseFloat(displayValue);

                    if (nextOperator === 'neg') {
                        displayValue = (parseFloat(displayValue) * -1).toString();
                        updateDisplay();
                        return;
                    }
                    if (nextOperator === '%') {
                        displayValue = (parseFloat(displayValue) / 100).toString();
                        updateDisplay();
                        return;
                    }

                    // Scientific functions
                    if (['sin', 'cos', 'tan', 'log', 'sqrt', 'pow2', 'pi', 'e'].includes(nextOperator)) {
                        let result;
                        switch (nextOperator) {
                            case 'sin': result = Math.sin(inputValue * Math.PI / 180); break; // Degrees
                            case 'cos': result = Math.cos(inputValue * Math.PI / 180); break; // Degrees
                            case 'tan': result = Math.tan(inputValue * Math.PI / 180); break; // Degrees
                            case 'log': result = Math.log10(inputValue); break;
                            case 'sqrt': result = Math.sqrt(inputValue); break;
                            case 'pow2': result = Math.pow(inputValue, 2); break;
                            case 'pi': result = Math.PI; break;
                            case 'e': result = Math.E; break;
                            default: return;
                        }
                        displayValue = result.toString();
                        updateDisplay();
                        return;
                    }


                    if (operator && waitingForSecondOperand) {
                        operator = nextOperator;
                        return;
                    }

                    if (firstOperand === null) {
                        firstOperand = inputValue;
                    } else if (operator) {
                        const result = performCalculation[operator](firstOperand, inputValue);
                        displayValue = `${parseFloat(result.toFixed(7))}`; // Limit float precision
                        firstOperand = result;
                    }

                    waitingForSecondOperand = true;
                    operator = nextOperator;
                    updateDisplay();
                }

                const performCalculation = {
                    '/': (firstOperand, secondOperand) => firstOperand / secondOperand,
                    '*': (firstOperand, secondOperand) => firstOperand * secondOperand,
                    '+': (firstOperand, secondOperand) => firstOperand + secondOperand,
                    '-': (firstOperand, secondOperand) => firstOperand - secondOperand,
                    '=': (firstOperand, secondOperand) => secondOperand // For equals, just return the second operand after calc
                };


                buttons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const target = e.target;
                        if (!target.matches('button')) return;

                        if (target.classList.contains('operator')) {
                            handleOperator(target.dataset.operator || target.textContent);
                            return;
                        }
                        if (target.classList.contains('decimal')) {
                            inputDecimal('.');
                            return;
                        }
                        if (target.classList.contains('clear')) {
                            clearCalculator();
                            return;
                        }
                        if (target.classList.contains('equal')) {
                            handleOperator('='); // Trigger calculation
                            firstOperand = null; // Reset for next calculation
                            operator = null;
                            waitingForSecondOperand = false;
                            return;
                        }
                        inputDigit(target.textContent);
                    });
                });

                // Initial display
                updateDisplay();

                function adjustDisplayFontSize() {
                    const currentWidth = display.offsetWidth;
                    if (currentWidth < 180) { // Adjusted breakpoint
                        display.style.fontSize = '1.5em';
                    } else if (currentWidth < 280) { // Adjusted breakpoint
                        display.style.fontSize = '2em';
                    } else {
                        display.style.fontSize = '2.2em';
                    }
                }

                // Call onResize initially and whenever widget is resized
                adjustDisplayFontSize();

                return {
                    destroy: () => {},
                    onResize: adjustDisplayFontSize
                };
            }

            /**
             * Grade Calculator Widget
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createGradeCalculatorWidget(contentDiv, widgetId) {
                let grades = loadSetting(`grades-${widgetId}`, []);

                contentDiv.innerHTML = `
                    <div class="grade-calc-input-group">
                        <input type="text" class="assignment-name-input" placeholder="Assignment Name">
                        <input type="number" step="0.1" min="0" class="score-input" placeholder="Score (e.g., 95.5)">
                        <input type="number" step="0.1" min="0" class="weight-input" placeholder="Weight (e.g., 20 for 20%)">
                        <button class="add-grade-btn">Add Grade</button>
                    </div>
                    <div class="grade-items">
                        </div>
                    <div class="grade-result">Overall Grade: N/A</div>
                `;

                const nameInput = contentDiv.querySelector('.assignment-name-input');
                const scoreInput = contentDiv.querySelector('.score-input');
                const weightInput = contentDiv.querySelector('.weight-input');
                const addBtn = contentDiv.querySelector('.add-grade-btn');
                const gradeItemsContainer = contentDiv.querySelector('.grade-items');
                const resultDisplay = contentDiv.querySelector('.grade-result');

                function calculateGrade() {
                    if (grades.length === 0) {
                        resultDisplay.textContent = 'Overall Grade: N/A';
                        return;
                    }

                    let totalWeightedScore = 0;
                    let totalWeight = 0;

                    grades.forEach(item => {
                        totalWeightedScore += (item.score * item.weight);
                        totalWeight += item.weight;
                    });

                    if (totalWeight === 0) {
                        resultDisplay.textContent = 'Overall Grade: 0 (Total weight is zero)';
                    } else {
                        const overallGrade = totalWeightedScore / totalWeight;
                        resultDisplay.textContent = `Overall Grade: ${overallGrade.toFixed(2)}%`;
                    }
                }

                function renderGrades() {
                    gradeItemsContainer.innerHTML = '';
                    grades.forEach((item, index) => {
                        const gradeDiv = document.createElement('div');
                        gradeDiv.classList.add('grade-item');
                        gradeDiv.innerHTML = `
                            <span>${item.name}: ${item.score}% (Weight: ${item.weight}%)</span>
                            <button data-index="${index}">Remove</button>
                        `;
                        gradeItemsContainer.appendChild(gradeDiv);
                    });
                    calculateGrade();
                    saveSetting(`grades-${widgetId}`, grades);
                }

                addBtn.addEventListener('click', () => {
                    const name = nameInput.value.trim();
                    const score = parseFloat(scoreInput.value);
                    const weight = parseFloat(weightInput.value);

                    if (name && !isNaN(score) && !isNaN(weight) && score >= 0 && weight >= 0) {
                        grades.push({ name, score, weight });
                        nameInput.value = '';
                        scoreInput.value = '';
                        weightInput.value = '';
                        renderGrades();
                    } else {
                        showMessageBox('Please enter valid assignment name, score, and weight.');
                    }
                });

                gradeItemsContainer.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON' && e.target.textContent === 'Remove') {
                        const indexToRemove = parseInt(e.target.dataset.index);
                        grades.splice(indexToRemove, 1);
                        renderGrades();
                    }
                });

                renderGrades(); // Initial render

                return {
                    destroy: () => {},
                    onResize: () => {}
                };
            }

            /**
             * Calendar Widget
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createCalendarWidget(contentDiv, widgetId) {
                let currentMonth = new Date().getMonth();
                let currentYear = new Date().getFullYear();

                contentDiv.innerHTML = `
                    <div class="calendar-widget-content">
                        <div class="calendar-header">
                            <button class="prev-month"><i class="fas fa-chevron-left"></i></button>
                            <h4 class="month-year-display"></h4>
                            <button class="next-month"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="calendar-grid">
                            <div class="day-name">Sun</div>
                            <div class="day-name">Mon</div>
                            <div class="day-name">Tue</div>
                            <div class="day-name">Wed</div>
                            <div class="day-name">Thu</div>
                            <div class="day-name">Fri</div>
                            <div class="day-name">Sat</div>
                            </div>
                    </div>
                `;

                const monthYearDisplay = contentDiv.querySelector('.month-year-display');
                const calendarGrid = contentDiv.querySelector('.calendar-grid');
                const prevMonthBtn = contentDiv.querySelector('.prev-month');
                const nextMonthBtn = contentDiv.querySelector('.next-month');

                function renderCalendar() {
                    calendarGrid.querySelectorAll('.day, .empty').forEach(el => {
                        if (!el.classList.contains('day-name')) el.remove();
                    }); // Clear previous days

                    const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay(); // 0 for Sunday, 6 for Saturday
                    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                    const today = new Date();
                    const todayDate = today.getDate();
                    const todayMonth = today.getMonth();
                    const todayYear = today.getFullYear();

                    monthYearDisplay.textContent = new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long', year: 'numeric' });

                    // Add empty divs for preceding days
                    for (let i = 0; i < firstDayOfMonth; i++) {
                        const emptyDiv = document.createElement('div');
                        emptyDiv.classList.add('empty');
                        calendarGrid.appendChild(emptyDiv);
                    }

                    // Add days of the month
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayDiv = document.createElement('div');
                        dayDiv.classList.add('day');
                        dayDiv.textContent = day;

                        if (day === todayDate && currentMonth === todayMonth && currentYear === todayYear) {
                            dayDiv.classList.add('current-day');
                        }
                        calendarGrid.appendChild(dayDiv);
                    }
                }

                prevMonthBtn.addEventListener('click', () => {
                    currentMonth--;
                    if (currentMonth < 0) {
                        currentMonth = 11;
                        currentYear--;
                    }
                    renderCalendar();
                });

                nextMonthBtn.addEventListener('click', () => {
                    currentMonth++;
                    if (currentMonth > 11) {
                        currentMonth = 0;
                        currentYear++;
                    }
                    renderCalendar();
                });

                renderCalendar(); // Initial render

                return {
                    destroy: () => {},
                    onResize: () => {}
                };
            }

            /**
             * PDF Viewer Widget
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createPdfViewerWidget(contentDiv, widgetId) {
                contentDiv.innerHTML = `
                    <div class="pdf-input-group">
                        <input type="file" accept="application/pdf" class="pdf-file-input">
                        <button class="load-pdf-btn">Load PDF</button>
                    </div>
                    <div class="pdf-viewer-container">
                        <iframe class="pdf-iframe" allowfullscreen></iframe>
                        <div class="pdf-placeholder" style="text-align: center; padding: 20px; color: var(--text-color-light);">
                            <i class="fas fa-file-pdf" style="font-size: 3em; color: var(--accent-color); margin-bottom: 10px;"></i>
                            <p>Upload a PDF file using the button above.</p>
                        </div>
                    </div>
                `;

                const pdfFileInput = contentDiv.querySelector('.pdf-file-input');
                const loadPdfBtn = contentDiv.querySelector('.load-pdf-btn');
                const pdfIframe = contentDiv.querySelector('.pdf-iframe');
                const pdfPlaceholder = contentDiv.querySelector('.pdf-placeholder');

                loadPdfBtn.addEventListener('click', () => {
                    const file = pdfFileInput.files[0];
                    if (file && file.type === 'application/pdf') {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            pdfIframe.src = e.target.result;
                            pdfPlaceholder.style.display = 'none'; // Hide placeholder
                        };
                        reader.readAsDataURL(file);
                    } else {
                        showMessageBox('Please select a valid PDF file.');
                        pdfPlaceholder.style.display = 'block';
                        pdfIframe.src = 'about:blank';
                    }
                });

                return {
                    destroy: () => {
                        pdfIframe.src = 'about:blank'; // Clear iframe content
                    },
                    onResize: () => {
                        // Iframe naturally scales to parent, no explicit resize needed here
                    }
                };
            }

            /**
             * Dictionary Widget
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createDictionaryWidget(contentDiv, widgetId) {
                contentDiv.innerHTML = `
                    <div class="dictionary-search-group">
                        <input type="text" class="dictionary-input" placeholder="Search word...">
                        <button class="dictionary-search-btn">Search</button>
                    </div>
                    <div class="dictionary-results">
                        <p style="text-align: center; color: var(--text-color-light);">Enter a word and click search to find its definition.</p>
                    </div>
                `;

                const searchInput = contentDiv.querySelector('.dictionary-input');
                const searchBtn = contentDiv.querySelector('.dictionary-search-btn');
                const resultsDiv = contentDiv.querySelector('.dictionary-results');

                const DICTIONARY_API_URL = 'https://api.dictionaryapi.dev/api/v2/entries/en/'; // Free Dictionary API

                async function searchWord(word) {
                    resultsDiv.innerHTML = '<p style="text-align: center; color: var(--text-color-light);">Searching...</p>';
                    try {
                        const response = await fetch(`${DICTIONARY_API_URL}${word}`);
                        if (!response.ok) {
                            if (response.status === 404) {
                                resultsDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">Word not found. Please try another word.</p>';
                            } else {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return;
                        }
                        const data = await response.json();
                        renderDictionaryResults(data);
                    } catch (error) {
                        console.error('Error fetching dictionary data:', error);
                        resultsDiv.innerHTML = `<p style="text-align: center; color: #dc3545;">Error fetching definition: ${error.message}</p>`;
                    }
                }

                function renderDictionaryResults(data) {
                    resultsDiv.innerHTML = '';
                    if (data && data.length > 0) {
                        data.forEach(entry => {
                            const wordTitle = document.createElement('h4');
                            wordTitle.textContent = entry.word;
                            resultsDiv.appendChild(wordTitle);

                            if (entry.phonetics && entry.phonetics.length > 0) {
                                entry.phonetics.forEach(phonetic => {
                                    if (phonetic.text) {
                                        const phoneticText = document.createElement('p');
                                        phoneticText.textContent = `/${phonetic.text}/`;
                                        resultsDiv.appendChild(phoneticText);
                                    }
                                    if (phonetic.audio) {
                                        const audioBtn = document.createElement('button');
                                        audioBtn.innerHTML = '<i class="fas fa-volume-up"></i> Listen';
                                        audioBtn.style.cssText = `
                                            background-color: var(--accent-color);
                                            color: white;
                                            border: none;
                                            padding: 5px 10px;
                                            border-radius: var(--border-radius);
                                            cursor: pointer;
                                            margin-left: 10px;
                                            font-size: 0.9em;
                                            transition: background-color 0.2s ease;
                                        `;
                                        audioBtn.onmouseover = () => audioBtn.style.backgroundColor = 'var(--accent-color-dark)';
                                        audioBtn.onmouseout = () => audioBtn.style.backgroundColor = 'var(--accent-color)';
                                        audioBtn.onclick = () => {
                                            new Audio(phonetic.audio).play().catch(e => console.error("Audio playback failed:", e));
                                        };
                                        resultsDiv.appendChild(audioBtn);
                                    }
                                });
                            }

                            entry.meanings.forEach(meaning => {
                                const partOfSpeech = document.createElement('p');
                                partOfSpeech.innerHTML = `<strong><em>${meaning.partOfSpeech}</em></strong>`;
                                resultsDiv.appendChild(partOfSpeech);

                                meaning.definitions.forEach((def, i) => {
                                    const definitionText = document.createElement('p');
                                    definitionText.textContent = `${i + 1}. ${def.definition}`;
                                    resultsDiv.appendChild(definitionText);
                                    if (def.example) {
                                        const exampleText = document.createElement('p');
                                        exampleText.innerHTML = `<em>"${def.example}"</em>`;
                                        exampleText.style.fontSize = '0.9em';
                                        exampleText.style.marginLeft = '20px';
                                        exampleText.style.color = 'var(--text-color-light)';
                                        resultsDiv.appendChild(exampleText);
                                    }
                                });
                            });
                            resultsDiv.appendChild(document.createElement('hr')).style.cssText = 'margin: 15px 0; border-color: var(--tertiary-bg);';
                        });
                    } else {
                        resultsDiv.innerHTML = '<p style="text-align: center; color: var(--text-color-light);">No results found.</p>';
                    }
                }

                searchBtn.addEventListener('click', () => {
                    const word = searchInput.value.trim();
                    if (word) {
                        searchWord(word);
                    } else {
                        resultsDiv.innerHTML = '<p style="text-align: center; color: var(--text-color-light);">Please enter a word to search.</p>';
                    }
                });

                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchBtn.click();
                    }
                });

                return {
                    destroy: () => {},
                    onResize: () => {}
                };
            }

            /**
             * Unit Converter Widget
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createUnitConverterWidget(contentDiv, widgetId) {
                const units = {
                    length: {
                        'meters': 1, 'kilometers': 1000, 'centimeters': 0.01, 'millimeters': 0.001,
                        'miles': 1609.34, 'yards': 0.9144, 'feet': 0.3048, 'inches': 0.0254
                    },
                    mass: {
                        'kilograms': 1, 'grams': 0.001, 'milligrams': 0.000001,
                        'pounds': 0.453592, 'ounces': 0.0283495
                    },
                    temperature: {
                        // Conversions to/from Kelvin (base unit)
                        'celsius': {
                            toBase: (c) => c + 273.15,
                            fromBase: (k) => k - 273.15
                        },
                        'fahrenheit': {
                            toBase: (f) => (f - 32) * 5/9 + 273.15,
                            fromBase: (k) => (k - 273.15) * 9/5 + 32
                        },
                        'kelvin': {
                            toBase: (k) => k,
                            fromBase: (k) => k
                        }
                    }
                };

                contentDiv.innerHTML = `
                    <div class="unit-converter-controls">
                        <select class="unit-type-select">
                            <option value="length">Length</option>
                            <option value="mass">Mass</option>
                            <option value="temperature">Temperature</option>
                        </select>

                        <div>
                            <input type="number" step="any" class="value-input" placeholder="Value">
                            <select class="from-unit-select"></select>
                        </div>
                        <div>
                            <select class="to-unit-select"></select>
                        </div>
                    </div>
                    <div class="unit-converter-result">Result: 0</div>
                `;

                const unitTypeSelect = contentDiv.querySelector('.unit-type-select');
                const valueInput = contentDiv.querySelector('.value-input');
                const fromUnitSelect = contentDiv.querySelector('.from-unit-select');
                const toUnitSelect = contentDiv.querySelector('.to-unit-select');
                const resultDisplay = contentDiv.querySelector('.unit-converter-result');

                function populateUnitOptions(type) {
                    fromUnitSelect.innerHTML = '';
                    toUnitSelect.innerHTML = '';
                    const currentUnits = units[type];
                    for (const unit in currentUnits) {
                        const option1 = document.createElement('option');
                        option1.value = unit;
                        option1.textContent = unit.charAt(0).toUpperCase() + unit.slice(1); // Capitalize first letter
                        fromUnitSelect.appendChild(option1);

                        const option2 = document.createElement('option');
                        option2.value = unit;
                        option2.textContent = unit.charAt(0).toUpperCase() + unit.slice(1);
                        toUnitSelect.appendChild(option2);
                    }
                }

                function convertUnits() {
                    const type = unitTypeSelect.value;
                    const value = parseFloat(valueInput.value);
                    const fromUnit = fromUnitSelect.value;
                    const toUnit = toUnitSelect.value;

                    if (isNaN(value)) {
                        resultDisplay.textContent = 'Result: Invalid Input';
                        return;
                    }

                    let convertedValue;

                    if (type === 'temperature') {
                        const tempUnits = units[type];
                        if (!tempUnits[fromUnit] || !tempUnits[toUnit]) {
                            resultDisplay.textContent = 'Result: Invalid Units';
                            return;
                        }
                        // Convert to Kelvin first
                        const valueInKelvin = tempUnits[fromUnit].toBase(value);
                        // Convert from Kelvin to target unit
                        convertedValue = tempUnits[toUnit].fromBase(valueInKelvin);
                    } else {
                        const conversionFactorFrom = units[type][fromUnit];
                        const conversionFactorTo = units[type][toUnit];

                        if (!conversionFactorFrom || !conversionFactorTo) {
                            resultDisplay.textContent = 'Result: Invalid Units';
                            return;
                        }
                        // Convert to base unit (e.g., meters or kilograms) then to target unit
                        convertedValue = (value * conversionFactorFrom) / conversionFactorTo;
                    }

                    resultDisplay.textContent = `Result: ${convertedValue.toFixed(4)}`;
                }

                unitTypeSelect.addEventListener('change', () => {
                    populateUnitOptions(unitTypeSelect.value);
                    convertUnits();
                });

                valueInput.addEventListener('input', convertUnits);
                fromUnitSelect.addEventListener('change', convertUnits);
                toUnitSelect.addEventListener('change', convertUnits);

                // Initial population and conversion
                populateUnitOptions(unitTypeSelect.value);
                convertUnits();

                return {
                    destroy: () => {},
                    onResize: () => {}
                };
            }

            /**
             * Clicker Widget
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createClickerWidget(contentDiv, widgetId) {
                let count = loadSetting(`clicker-${widgetId}-count`, 0);

                contentDiv.innerHTML = `
                    <div class="clicker-display">${count}</div>
                    <div class="clicker-controls">
                        <button class="click-btn">Click Me!</button>
                        <button class="reset-btn">Reset</button>
                    </div>
                `;

                const display = contentDiv.querySelector('.clicker-display');
                const clickBtn = contentDiv.querySelector('.click-btn');
                const resetBtn = contentDiv.querySelector('.reset-btn');

                clickBtn.addEventListener('click', () => {
                    count++;
                    display.textContent = count;
                    saveSetting(`clicker-${widgetId}-count`, count);
                });

                resetBtn.addEventListener('click', () => {
                    count = 0;
                    display.textContent = count;
                    saveSetting(`clicker-${widgetId}-count`, count);
                });

                return {
                    destroy: () => {},
                    onResize: () => {}
                };
            }

            /**
             * Quote Generator Widget
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createQuoteGeneratorWidget(contentDiv, widgetId) {
                contentDiv.innerHTML = `
                    <div class="quote-display">
                        <p class="quote-text">Click "New Quote" to get started!</p>
                        <p class="quote-author"></p>
                    </div>
                    <div class="quote-controls">
                        <button class="new-quote-btn">New Quote</button>
                    </div>
                `;

                const quoteText = contentDiv.querySelector('.quote-text');
                const quoteAuthor = contentDiv.querySelector('.quote-author');
                const newQuoteBtn = contentDiv.querySelector('.new-quote-btn');

                // Using a more reliable API for quotes
                // Source: https://type.fit/api/quotes (a static JSON array, good for client-side)
                const QUOTE_API_URL = 'https://type.fit/api/quotes';
                let quotesData = []; // To store fetched quotes

                async function fetchQuotes() {
                    quoteText.textContent = 'Loading quotes...';
                    quoteAuthor.textContent = '';
                    try {
                        const response = await fetch(QUOTE_API_URL);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        quotesData = await response.json();
                        displayRandomQuote();
                    } catch (error) {
                        console.error('Error fetching quotes:', error);
                        quoteText.textContent = 'Failed to load quotes.';
                        quoteAuthor.textContent = 'Please try again.';
                    }
                }

                function displayRandomQuote() {
                    if (quotesData.length > 0) {
                        const randomIndex = Math.floor(Math.random() * quotesData.length);
                        const quote = quotesData[randomIndex];
                        quoteText.textContent = `"${quote.text}"`;
                        quoteAuthor.textContent = `- ${quote.author || 'Unknown'}`; // Handle unknown authors
                    } else {
                        quoteText.textContent = 'No quotes loaded. Try reloading the widget or check internet connection.';
                        quoteAuthor.textContent = '';
                    }
                }

                newQuoteBtn.addEventListener('click', displayRandomQuote);

                // Fetch quotes immediately when widget is created
                fetchQuotes();

                return {
                    destroy: () => {},
                    onResize: () => {}
                };
            }

            /**
             * To Do List Widget
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createTodoListWidget(contentDiv, widgetId) {
                let todos = loadSetting(`todo-${widgetId}-tasks`, []);

                contentDiv.innerHTML = `
                    <div class="todo-input-group">
                        <input type="text" class="todo-input" placeholder="Add a new task...">
                        <button class="add-todo-btn">Add</button>
                    </div>
                    <div class="todo-list"></div>
                `;

                const todoInput = contentDiv.querySelector('.todo-input');
                const addTodoBtn = contentDiv.querySelector('.add-todo-btn');
                const todoListContainer = contentDiv.querySelector('.todo-list');

                function renderTodos() {
                    todoListContainer.innerHTML = '';
                    todos.forEach((todo, index) => {
                        const todoItemDiv = document.createElement('div');
                        todoItemDiv.classList.add('todo-item');
                        if (todo.completed) {
                            todoItemDiv.classList.add('completed');
                        }
                        todoItemDiv.innerHTML = `
                            <input type="checkbox" data-index="${index}" ${todo.completed ? 'checked' : ''}>
                            <span>${todo.text}</span>
                            <button data-index="${index}">Delete</button>
                        `;
                        todoListContainer.appendChild(todoItemDiv);
                    });
                    saveSetting(`todo-${widgetId}-tasks`, todos);
                }

                addTodoBtn.addEventListener('click', () => {
                    const text = todoInput.value.trim();
                    if (text) {
                        todos.push({ text, completed: false });
                        todoInput.value = '';
                        renderTodos();
                    } else {
                        showMessageBox('Please enter a task.');
                    }
                });

                todoInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addTodoBtn.click();
                    }
                });

                todoListContainer.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        const index = parseInt(e.target.dataset.index);
                        todos[index].completed = e.target.checked;
                        renderTodos();
                    }
                });

                todoListContainer.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON' && e.target.textContent === 'Delete') {
                        const index = parseInt(e.target.dataset.index);
                        todos.splice(index, 1);
                        renderTodos();
                    }
                });

                renderTodos(); // Initial render

                return {
                    destroy: () => {},
                    onResize: () => {}
                };
            }

            /**
             * Notes Widget
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createNotesWidget(contentDiv, widgetId) {
                let noteContent = loadSetting(`notes-${widgetId}-content`, '');

                contentDiv.innerHTML = `
                    <textarea class="notes-textarea" placeholder="Write your notes here..."></textarea>
                `;

                const notesTextarea = contentDiv.querySelector('.notes-textarea');
                notesTextarea.value = noteContent;

                notesTextarea.addEventListener('input', () => {
                    saveSetting(`notes-${widgetId}-content`, notesTextarea.value);
                });

                return {
                    destroy: () => {},
                    onResize: () => {}
                };
            }

            /**
             * Pomodoro Timer Widget
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createPomodoroTimerWidget(contentDiv, widgetId) {
                let timerInterval;
                let isRunning = false;
                let currentPhase = 'work'; // 'work' or 'break'
                let workDuration = loadSetting(`pomodoro-${widgetId}-workDuration`, 25 * 60); // 25 minutes
                let breakDuration = loadSetting(`pomodoro-${widgetId}-breakDuration`, 5 * 60); // 5 minutes
                let remainingSeconds = workDuration;

                contentDiv.innerHTML = `
                    <div class="pomodoro-controls">
                        Work: <input type="number" min="1" max="60" value="${workDuration / 60}" class="work-duration-input"> min
                        Break: <input type="number" min="1" max="30" value="${breakDuration / 60}" class="break-duration-input"> min
                        <button class="start-pause-btn">Start</button>
                        <button class="reset-btn">Reset</button>
                        <button class="skip-btn">Skip</button>
                    </div>
                    <div class="pomodoro-display"></div>
                    <div class="pomodoro-status">Work Time</div>
                `;

                const workDurationInput = contentDiv.querySelector('.work-duration-input');
                const breakDurationInput = contentDiv.querySelector('.break-duration-input');
                const startPauseBtn = contentDiv.querySelector('.start-pause-btn');
                const resetBtn = contentDiv.querySelector('.reset-btn');
                const skipBtn = contentDiv.querySelector('.skip-btn');
                const display = contentDiv.querySelector('.pomodoro-display');
                const statusDisplay = contentDiv.querySelector('.pomodoro-status');

                // Apply flexible styling to inputs
                workDurationInput.style.cssText = `flex-grow: 1; max-width: 60px; padding: 8px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--primary-bg); color: var(--text-color); text-align: center;`;
                breakDurationInput.style.cssText = `flex-grow: 1; max-width: 60px; padding: 8px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--primary-bg); color: var(--text-color); text-align: center;`;


                function updateDisplay() {
                    display.textContent = formatTime(remainingSeconds);
                    statusDisplay.textContent = currentPhase === 'work' ? 'Work Time' : 'Break Time';
                }

                function startTimer() {
                    if (!isRunning && remainingSeconds > 0) {
                        isRunning = true;
                        startPauseBtn.textContent = 'Pause';
                        timerInterval = setInterval(() => {
                            remainingSeconds--;
                            updateDisplay();
                            if (remainingSeconds <= 0) {
                                clearInterval(timerInterval);
                                isRunning = false;
                                showMessageBox(`${currentPhase === 'work' ? 'Work' : 'Break'} time finished!`);
                                togglePhase();
                            }
                        }, 1000);
                    }
                }

                function pauseTimer() {
                    if (isRunning) {
                        isRunning = false;
                        startPauseBtn.textContent = 'Start';
                        clearInterval(timerInterval);
                    }
                }

                function resetTimer() {
                    pauseTimer();
                    currentPhase = 'work';
                    remainingSeconds = workDuration;
                    updateDisplay();
                    startPauseBtn.textContent = 'Start';
                }

                function togglePhase() {
                    pauseTimer();
                    if (currentPhase === 'work') {
                        currentPhase = 'break';
                        remainingSeconds = breakDuration;
                    } else {
                        currentPhase = 'work';
                        remainingSeconds = workDuration;
                    }
                    updateDisplay();
                    startTimer(); // Automatically start the next phase
                }

                workDurationInput.addEventListener('change', () => {
                    workDuration = parseInt(workDurationInput.value) * 60 || (25 * 60);
                    saveSetting(`pomodoro-${widgetId}-workDuration`, workDuration);
                    if (currentPhase === 'work' && !isRunning) {
                        remainingSeconds = workDuration;
                        updateDisplay();
                    }
                });

                breakDurationInput.addEventListener('change', () => {
                    breakDuration = parseInt(breakDurationInput.value) * 60 || (5 * 60);
                    saveSetting(`pomodoro-${widgetId}-breakDuration`, breakDuration);
                    if (currentPhase === 'break' && !isRunning) {
                        remainingSeconds = breakDuration;
                        updateDisplay();
                    }
                });

                startPauseBtn.addEventListener('click', () => {
                    if (isRunning) {
                        pauseTimer();
                    } else {
                        startTimer();
                    }
                });

                resetBtn.addEventListener('click', resetTimer);
                skipBtn.addEventListener('click', togglePhase);

                updateDisplay(); // Initial display

                function adjustDisplayFontSize() {
                    const widgetElement = display.closest('.widget'); // Get the parent widget element
                    const currentHeight = display.offsetHeight;
                    const currentWidth = display.offsetWidth;

                    if (widgetElement && widgetElement.classList.contains('fullscreen')) {
                        // Fullscreen mode: set a consistently large size
                        display.style.fontSize = '8em'; // Large fixed size for fullscreen
                    } else {
                        // Regular mode: scale based on available space
                        const sizeBasedOnHeight = currentHeight / 3; // Roughly 1/3 of height
                        const sizeBasedOnWidth = currentWidth / 6; // Roughly 1/6 of width for 00:00:00
                        display.style.fontSize = `${Math.min(sizeBasedOnHeight, sizeBasedOnWidth)}px`;
                    }
                }

                // Call onResize initially and whenever widget is resized
                adjustDisplayFontSize();

                return {
                    destroy: () => {
                        clearInterval(timerInterval);
                    },
                    onResize: adjustDisplayFontSize
                };
            }

            /**
             * Image Upload Widget
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createImageUploadWidget(contentDiv, widgetId) {
                let imageDataUrl = loadSetting(`image-upload-${widgetId}-data`, null);

                contentDiv.innerHTML = `
                    <div class="image-upload-container">
                        <img class="uploaded-image" src="" alt="Uploaded Image" style="${imageDataUrl ? '' : 'display:none;'}">
                        <p class="image-placeholder" style="${imageDataUrl ? 'display:none;' : ''} color: var(--text-color-light);">
                            <i class="fas fa-image" style="font-size: 2em; color: var(--accent-color); margin-bottom: 10px;"></i><br>Upload an image.
                        </p>
                    </div>
                    <div class="image-upload-controls">
                        <input type="file" accept="image/*" class="image-file-input">
                        <button class="clear-image-btn">Clear Image</button>
                    </div>
                `;

                const uploadedImage = contentDiv.querySelector('.uploaded-image');
                const imagePlaceholder = contentDiv.querySelector('.image-placeholder');
                const imageFileInput = contentDiv.querySelector('.image-file-input');
                const clearImageBtn = contentDiv.querySelector('.clear-image-btn');

                if (imageDataUrl) {
                    uploadedImage.src = imageDataUrl;
                }

                imageFileInput.addEventListener('change', () => {
                    const file = imageFileInput.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            uploadedImage.src = e.target.result;
                            uploadedImage.style.display = 'block';
                            imagePlaceholder.style.display = 'none';
                            saveSetting(`image-upload-${widgetId}-data`, e.target.result);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        showMessageBox('Please select an image file.');
                    }
                });

                clearImageBtn.addEventListener('click', () => {
                    uploadedImage.src = '';
                    uploadedImage.style.display = 'none';
                    imagePlaceholder.style.display = 'block';
                    saveSetting(`image-upload-${widgetId}-data`, null);
                });

                return {
                    destroy: () => {},
                    onResize: () => {
                        // Image scaling is handled by CSS object-fit: contain and max-width/height: 100%
                    }
                };
            }

            /**
             * NEW WIDGET: Number Guessing Game
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createNumberGuessingGameWidget(contentDiv, widgetId) {
                let targetNumber;
                let attempts;
                let maxAttempts = 5; // You can adjust difficulty
                let minNum = 1;
                let maxNum = 100;

                contentDiv.innerHTML = `
                    <div class="game-display">
                        <p class="game-instructions">Guess a number between ${minNum} and ${maxNum}.</p>
                        <input type="number" class="game-input" min="${minNum}" max="${maxNum}" placeholder="Your guess">
                        <p class="game-message"></p>
                        <p class="game-attempts">Attempts left: ${maxAttempts}</p>
                    </div>
                    <div class="game-controls">
                        <button class="guess-btn">Guess</button>
                        <button class="reset-game-btn">Reset Game</button>
                    </div>
                `;

                const instructionsDisplay = contentDiv.querySelector('.game-instructions');
                const guessInput = contentDiv.querySelector('.game-input');
                const messageDisplay = contentDiv.querySelector('.game-message');
                const attemptsDisplay = contentDiv.querySelector('.game-attempts');
                const guessBtn = contentDiv.querySelector('.guess-btn');
                const resetGameBtn = contentDiv.querySelector('.reset-game-btn');

                function startGame() {
                    targetNumber = Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum;
                    attempts = maxAttempts;
                    messageDisplay.textContent = '';
                    guessInput.value = '';
                    guessInput.disabled = false;
                    guessBtn.disabled = false;
                    attemptsDisplay.textContent = `Attempts left: ${attempts}`;
                    instructionsDisplay.textContent = `Guess a number between ${minNum} and ${maxNum}.`;
                }

                function checkGuess() {
                    const guess = parseInt(guessInput.value);

                    if (isNaN(guess) || guess < minNum || guess > maxNum) {
                        messageDisplay.textContent = `Please enter a valid number between ${minNum} and ${maxNum}.`;
                        return;
                    }

                    attempts--;
                    attemptsDisplay.textContent = `Attempts left: ${attempts}`;

                    if (guess === targetNumber) {
                        messageDisplay.textContent = ` Correct! You guessed the number ${targetNumber}!`;
                        guessInput.disabled = true;
                        guessBtn.disabled = true;
                    } else if (attempts === 0) {
                        messageDisplay.textContent = ` Game Over! The number was ${targetNumber}.`;
                        guessInput.disabled = true;
                        guessBtn.disabled = true;
                    } else if (guess < targetNumber) {
                        messageDisplay.textContent = 'Too low! Try again.';
                    } else {
                        messageDisplay.textContent = 'Too high! Try again.';
                    }
                }

                guessBtn.addEventListener('click', checkGuess);
                guessInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        checkGuess();
                    }
                });
                resetGameBtn.addEventListener('click', startGame);

                startGame(); // Initial game setup

                return {
                    destroy: () => {},
                    onResize: () => {}
                };
            }

            /**
             * NEW WIDGET: Formula Book
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createFormulaBookWidget(contentDiv, widgetId) {
                const formulas = {
                    math: [
                        { name: "Quadratic Formula", formula: "$$x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$$" },
                        { name: "Pythagorean Theorem", formula: "$$a^2 + b^2 = c^2$$" },
                        { name: "Area of a Circle", formula: "$$A = \\pi r^2$$" },
                        { name: "Circumference of a Circle", formula: "$$C = 2\\pi r$$" },
                        { name: "Area of a Triangle", formula: "$$A = \\frac{1}{2}bh$$" },
                        { name: "Slope-Intercept Form", formula: "$$y = mx + b$$" },
                        { name: "Distance Formula", formula: "$$d = \\sqrt{(x_2-x_1)^2 + (y_2-y_1)^2}$$" },
                        { name: "Midpoint Formula", formula: "$$M = \\left(\\frac{x_1+x_2}{2}, \\frac{y_1+y_2}{2}\\right)$$" },
                        { name: "Sum of Arithmetic Series", formula: "$$S_n = \\frac{n}{2}(a_1 + a_n)$$" },
                        { name: "Sum of Geometric Series", formula: "$$S_n = a_1\\frac{1-r^n}{1-r}$$" },
                    ],
                    physics: [
                        { name: "Newton's Second Law", formula: "$$F = ma$$" },
                        { name: "Kinetic Energy", formula: "$$KE = \\frac{1}{2}mv^2$$" },
                        { name: "Potential Energy (Gravitational)", formula: "$$PE = mgh$$" },
                        { name: "Ohm's Law", formula: "$$V = IR$$" },
                        { name: "Work Done", formula: "$$W = Fd\\cos\\theta$$" },
                        { name: "Power", formula: "$$P = \\frac{W}{t} = Fv$$" },
                        { name: "Wave Speed", formula: "$$v = f\\lambda$$" },
                        { name: "Speed of Light", formula: "$$c \\approx 3 \\times 10^8 \\text{ m/s}$$" },
                        { name: "Einstein's Mass-Energy Equivalence", formula: "$$E = mc^2$$" },
                        { name: "Centripetal Force", formula: "$$F_c = \\frac{mv^2}{r}$$" },
                    ],
                    chemistry: [
                        { name: "Ideal Gas Law", formula: "$$PV = nRT$$" },
                        { name: "Molarity", formula: "$$M = \\frac{\\text{moles of solute}}{\\text{liters of solution}}$$" },
                        { name: "pH Calculation", formula: "$$pH = -\\log[H^+]$$" },
                        { name: "Mole Formula", formula: "$$\\text{moles} = \\frac{\\text{mass}}{\\text{molar mass}}$$" },
                        { name: "Density", formula: "$$\\rho = \\frac{m}{V}$$" },
                        { name: "Avogadro's Number", formula: "$$N_A \\approx 6.022 \\times 10^{23} \\text{ mol}^{-1}$$" },
                        { name: "Heat Transfer (Calorimetry)", formula: "$$Q = mc\\Delta T$$" },
                        { name: "Dilution Equation", formula: "$$M_1V_1 = M_2V_2$$" },
                    ]
                };

                contentDiv.innerHTML = `
                    <select class="formula-category-select">
                        <option value="math">Math</option>
                        <option value="physics">Physics</option>
                        <option value="chemistry">Chemistry</option>
                    </select>
                    <div class="formula-list"></div>
                `;

                const categorySelect = contentDiv.querySelector('.formula-category-select');
                const formulaListDiv = contentDiv.querySelector('.formula-list');

                function renderFormulas(category) {
                    formulaListDiv.innerHTML = '';
                    const selectedFormulas = formulas[category];
                    if (selectedFormulas) {
                        selectedFormulas.forEach(item => {
                            const formulaEntry = document.createElement('div');
                            formulaEntry.innerHTML = `
                                <h5>${item.name}</h5>
                                <p><span class="formula">${item.formula}</span></p>
                            `;
                            formulaListDiv.appendChild(formulaEntry);
                        });
                        // Basic math rendering emulation for the formulas
                        formulaListDiv.querySelectorAll('.formula').forEach(formulaSpan => {
                            let text = formulaSpan.textContent;
                            // Replace common math symbols with better representations
                            text = text.replace(/\*\*/g, '^'); // Power
                            text = text.replace(/\//g, ''); // Division slash
                            text = text.replace(/\\pi/g, '');
                            text = text.replace(/\\alpha/g, '');
                            text = text.replace(/\\beta/g, '');
                            text = text.replace(/\\gamma/g, '');
                            text = text.replace(/\\theta/g, '');
                            text = text.replace(/\\lambda/g, '');
                            text = text.replace(/\\Delta T/g, 'T');
                            text = text.replace(/\\pm/g, '');
                            text = text.replace(/\\sqrt\{([^}]+)\}/g, '($1)'); // Square root
                            text = text.replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '($1)/($2)'); // Fractions
                            text = text.replace(/\$\$|\$/g, ''); // Remove LaTeX delimiters

                            // Attempt to format subscripts/superscripts simply
                            text = text.replace(/([a-zA-Z0-9])_([a-zA-Z0-9])/g, '$1\u2082$2'); // e.g., H_2 -> H
                            text = text.replace(/([a-zA-Z0-9])\^([a-zA-Z0-9])/g, '$1\u00B2'); // e.g., x^2 -> x (simple case)
                            text = text.replace(/([a-zA-Z0-9])\^\{(.*?)\}/g, '$1<sup>$2</sup>'); // e.g., x^{y} -> x

                            formulaSpan.innerHTML = text;
                        });
                    } else {
                        formulaListDiv.innerHTML = '<p style="text-align: center; color: var(--text-color-light);">Select a category to view formulas.</p>';
                    }
                }

                categorySelect.addEventListener('change', (e) => {
                    renderFormulas(e.target.value);
                });

                renderFormulas(categorySelect.value); // Initial render

                return {
                    destroy: () => {},
                    onResize: () => {
                        // Re-render formulas to potentially adjust font size if needed (e.g. for very small widgets)
                        renderFormulas(categorySelect.value);
                    }
                };
            }

            /**
             * NEW WIDGET: Periodic Table
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createPeriodicTableWidget(contentDiv, widgetId) {
                const elements = [
                    {n:1,s:"H",name:"Hydrogen",mass:1.008}, {n:2,s:"He",name:"Helium",mass:4.0026},
                    {n:3,s:"Li",name:"Lithium",mass:6.94}, {n:4,s:"Be",name:"Beryllium",mass:9.0122}, {n:5,s:"B",name:"Boron",mass:10.81}, {n:6,s:"C",name:"Carbon",mass:12.011}, {n:7,s:"N",name:"Nitrogen",mass:14.007}, {n:8,s:"O",name:"Oxygen",mass:15.999}, {n:9,s:"F",name:"Fluorine",mass:18.998}, {n:10,s:"Ne",name:"Neon",mass:20.180},
                    {n:11,s:"Na",name:"Sodium",mass:22.990}, {n:12,s:"Mg",name:"Magnesium",mass:24.305}, {n:13,s:"Al",name:"Aluminum",mass:26.982}, {n:14,s:"Si",name:"Silicon",mass:28.085}, {n:15,s:"P",name:"Phosphorus",mass:30.974}, {n:16,s:"S",name:"Sulfur",mass:32.06}, {n:17,s:"Cl",name:"Chlorine",mass:35.45}, {n:18,s:"Ar",name:"Argon",mass:39.948},
                    {n:19,s:"K",name:"Potassium",mass:39.098}, {n:20,s:"Ca",name:"Calcium",mass:40.078}, {n:21,s:"Sc",name:"Scandium",mass:44.956}, {n:22,s:"Ti",name:"Titanium",mass:47.867}, {n:23,s:"V",name:"Vanadium",mass:50.942}, {n:24,s:"Cr",name:"Chromium",mass:51.996}, {n:25,s:"Mn",name:"Manganese",mass:54.938}, {n:26,s:"Fe",name:"Iron",mass:55.845}, {n:27,s:"Co",name:"Cobalt",mass:58.933}, {n:28,s:"Ni",name:"Nickel",mass:58.693}, {n:29,s:"Cu",name:"Copper",mass:63.546}, {n:30,s:"Zn",name:"Zinc",mass:65.38}, {n:31,s:"Ga",name:"Gallium",mass:69.723}, {n:32,s:"Ge",name:"Germanium",mass:72.63}, {n:33,s:"As",name:"Arsenic",mass:74.922}, {n:34,s:"Se",name:"Selenium",mass:78.971}, {n:35,s:"Br",name:"Bromine",mass:79.904}, {n:36,s:"Kr",name:"Krypton",mass:83.798},
                    {n:37,s:"Rb",name:"Rubidium",mass:85.468}, {n:38,s:"Sr",name:"Strontium",mass:87.62}, {n:39,s:"Y",name:"Yttrium",mass:88.906}, {n:40,s:"Zr",name:"Zirconium",mass:91.224}, {n:41,s:"Nb",name:"Niobium",mass:92.906}, {n:42,s:"Mo",name:"Molybdenum",mass:95.96}, {n:43,s:"Tc",name:"Technetium",mass:98}, {n:44,s:"Ru",name:"Ruthenium",mass:101.07}, {n:45,s:"Rh",name:"Rhodium",mass:102.91}, {n:46,s:"Pd",name:"Palladium",mass:106.42}, {n:47,s:"Ag",name:"Silver",mass:107.868}, {n:48,s:"Cd",name:"Cadmium",mass:112.414}, {n:49,s:"In",name:"Indium",mass:114.818}, {n:50,s:"Sn",name:"Tin",mass:118.710}, {n:51,s:"Sb",name:"Antimony",mass:121.760}, {n:52,s:"Te",name:"Tellurium",mass:127.60}, {n:53,s:"I",name:"Iodine",mass:126.904}, {n:54,s:"Xe",name:"Xenon",mass:131.293},
                    {n:55,s:"Cs",name:"Cesium",mass:132.905}, {n:56,s:"Ba",name:"Barium",mass:137.327},
                    {n:57,s:"La",name:"Lanthanum",mass:138.905}, {n:58,s:"Ce",name:"Cerium",mass:140.116}, {n:59,s:"Pr",name:"Praseodymium",mass:140.907}, {n:60,s:"Nd",name:"Neodymium",mass:144.242}, {n:61,s:"Pm",name:"Promethium",mass:145}, {n:62,s:"Sm",name:"Samarium",mass:150.36}, {n:63,s:"Eu",name:"Europium",mass:151.964}, {n:64,s:"Gd",name:"Gadolinium",mass:157.25}, {n:65,s:"Tb",name:"Terbium",mass:158.925}, {n:66,s:"Dy",name:"Dysprosium",mass:162.500}, {n:67,s:"Ho",name:"Holmium",mass:164.930}, {n:68,s:"Er",name:"Erbium",mass:167.259}, {n:69,s:"Tm",name:"Thulium",mass:168.934}, {n:70,s:"Yb",name:"Ytterbium",mass:173.04}, {n:71,s:"Lu",name:"Lutetium",mass:174.966},
                    {n:72,s:"Hf",name:"Hafnium",mass:178.49}, {n:73,s:"Ta",name:"Tantalum",mass:180.947}, {n:74,s:"W",name:"Tungsten",mass:183.84}, {n:75,s:"Re",name:"Rhenium",mass:186.207}, {n:76,s:"Os",name:"Osmium",mass:190.23}, {n:77,s:"Ir",name:"Iridium",mass:192.217}, {n:78,s:"Pt",name:"Platinum",mass:195.084}, {n:79,s:"Au",name:"Gold",mass:196.967}, {n:80,s:"Hg",name:"Mercury",mass:200.592}, {n:81,s:"Tl",name:"Thallium",mass:204.383}, {n:82,s:"Pb",name:"Lead",mass:207.2}, {n:83,s:"Bi",name:"Bismuth",mass:208.980}, {n:84,s:"Po",name:"Polonium",mass:209}, {n:85,s:"At",name:"Astatine",mass:210}, {n:86,s:"Rn",name:"Radon",mass:222},
                    {n:87,s:"Fr",name:"Francium",mass:223}, {n:88,s:"Ra",name:"Radium",mass:226},
                    {n:89,s:"Ac",name:"Actinium",mass:227}, {n:90,s:"Th",name:"Thorium",mass:232.038}, {n:91,s:"Pa",name:"Protactinium",mass:231.036}, {n:92,s:"U",name:"Uranium",mass:238.028}, {n:93,s:"Np",name:"Neptunium",mass:237}, {n:94,s:"Pu",name:"Plutonium",mass:244}, {n:95,s:"Am",name:"Americium",mass:243}, {n:96,s:"Cm",name:"Curium",mass:247}, {n:97,s:"Bk",name:"Berkelium",mass:247}, {n:98,s:"Cf",name:"Californium",mass:251}, {n:99,s:"Es",name:"Einsteinium",mass:252}, {n:100,s:"Fm",name:"Fermium",mass:257}, {n:101,s:"Md",name:"Mendelevium",mass:258}, {n:102,s:"No",name:"Nobelium",mass:259}, {n:103,s:"Lr",name:"Lawrencium",mass:262},
                    {n:104,s:"Rf",name:"Rutherfordium",mass:267}, {n:105,s:"Db",name:"Dubnium",mass:268}, {n:106,s:"Sg",name:"Seaborgium",mass:269}, {n:107,s:"Bh",name:"Bohrium",mass:270}, {n:108,s:"Hs",name:"Hassium",mass:269}, {n:109,s:"Mt",name:"Meitnerium",mass:278}, {n:110,s:"Ds",name:"Darmstadtium",mass:281}, {n:111,s:"Rg",name:"Roentgenium",mass:282}, {n:112,s:"Cn",name:"Copernicium",mass:285}, {n:113,s:"Nh",name:"Nihonium",mass:286}, {n:114,s:"Fl",name:"Flerovium",mass:289}, {n:115,s:"Mc",name:"Moscovium",mass:290}, {n:116,s:"Lv",name:"Livermorium",mass:293}, {n:117,s:"Ts",name:"Tennessine",mass:294}, {n:118,s:"Og",name:"Oganesson",mass:294}
                ];

                contentDiv.innerHTML = `
                    <div class="periodic-table-grid"></div>
                `;

                const grid = contentDiv.querySelector('.periodic-table-grid');

                // Map to store element positions for the grid layout (row, column)
                // This manually defines the layout of the periodic table
                const elementPositions = {
                    1: [1,1], 2: [1,18],
                    3: [2,1], 4: [2,2], 5: [2,13], 6: [2,14], 7: [2,15], 8: [2,16], 9: [2,17], 10: [2,18],
                    11: [3,1], 12: [3,2], 13: [3,13], 14: [3,14], 15: [3,15], 16: [3,16], 17: [3,17], 18: [3,18],
                    19: [4,1], 20: [4,2], 21: [4,3], 22: [4,4], 23: [4,5], 24: [4,6], 25: [4,7], 26: [4,8], 27: [4,9], 28: [4,10], 29: [4,11], 30: [4,12], 31: [4,13], 32: [4,14], 33: [4,15], 34: [4,16], 35: [4,17], 36: [4,18],
                    37: [5,1], 38: [5,2], 39: [5,3], 40: [5,4], 41: [5,5], 42: [5,6], 43: [5,7], 44: [5,8], 45: [5,9], 46: [5,10], 47: [5,11], 48: [5,12], 49: [5,13], 50: [5,14], 51: [5,15], 52: [5,16], 53: [5,17], 54: [5,18],
                    55: [6,1], 56: [6,2], 57: [6,3], // La is here
                    72: [6,4], 73: [6,5], 74: [6,6], 75: [6,7], 76: [6,8], 77: [6,9], 78: [6,10], 79: [6,11], 80: [6,12], 81: [6,13], 82: [6,14], 83: [6,15], 84: [6,16], 85: [6,17], 86: [6,18],
                    87: [7,1], 88: [7,2], 89: [7,3], // Ac is here
                    104: [7,4], 105: [7,5], 106: [7,6], 107: [7,7], 108: [7,8], 109: [7,9], 110: [7,10], 111: [7,11], 112: [7,12], 113: [7,13], 114: [7,14], 115: [7,15], 116: [7,16], 117: [7,17], 118: [7,18],
                    // Lanthanides (row 8, offset by 3 columns to align with main table)
                    58: [8,4], 59: [8,5], 60: [8,6], 61: [8,7], 62: [8,8], 63: [8,9], 64: [8,10], 65: [8,11], 66: [8,12], 67: [8,13], 68: [8,14], 69: [8,15], 70: [8,16], 71: [8,17],
                    // Actinides (row 9, offset by 3 columns)
                    90: [9,4], 91: [9,5], 92: [9,6], 93: [9,7], 94: [9,8], 95: [9,9], 96: [9,10], 97: [9,11], 98: [9,12], 99: [9,13], 100: [9,14], 101: [9,15], 102: [9,16], 103: [9,17],
                };

                // Helper to create an empty cell
                const createEmptyCell = () => {
                    const cellDiv = document.createElement('div');
                    cellDiv.classList.add('empty-cell');
                    return cellDiv;
                };

                // Render function
                function renderPeriodicTable() {
                    grid.innerHTML = ''; // Clear existing grid

                    const maxRow = 9; // Rows 1-7 for main table, 8-9 for lanthanides/actinides
                    const maxCol = 18;

                    for (let r = 1; r <= maxRow; r++) {
                        for (let c = 1; c <= maxCol; c++) {
                            // Find element for current row/col
                            const element = elements.find(e => {
                                const pos = elementPositions[e.n];
                                return pos && pos[0] === r && pos[1] === c;
                            });

                            if (element) {
                                const cellDiv = document.createElement('div');
                                cellDiv.classList.add('element-cell');
                                cellDiv.innerHTML = `
                                    <span class="number">${element.n}</span>
                                    <span class="symbol">${element.s}</span>
                                    <span class="name">${element.name}</span>
                                    <span class="mass">${element.mass.toFixed(3)}</span>
                                `;
                                cellDiv.title = `${element.name} (${element.s}) - Atomic No: ${element.n}, Mass: ${element.mass.toFixed(3)}`; // Tooltip
                                grid.appendChild(cellDiv);
                            } else {
                                // Add empty cells for gaps in the table
                                // Special handling for Lanthanides/Actinides row start to create initial gap
                                if ((r === 8 || r === 9) && c < 4) { // Gap before first Lanthanide/Actinide
                                    grid.appendChild(createEmptyCell());
                                } else if (!(r === 6 && c === 3) && !(r === 7 && c === 3)) { // Don't add empty where La/Ac symbols are
                                    grid.appendChild(createEmptyCell());
                                }
                            }
                        }
                    }
                }

                renderPeriodicTable(); // Initial render

                return {
                    destroy: () => {},
                    onResize: () => {
                        // The CSS for periodic-table-grid with `minmax(20px, 1fr)` and `overflow: auto`
                        // coupled with `element-cell` having `aspect-ratio` and `min-width/height`
                        // should handle responsiveness and scrolling automatically.
                        // No need for JS font size adjustments unless extremely specific behaviors are desired.
                    }
                };
            }

            /**
             * NEW WIDGET: Simple Text Summarizer
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createTextSummarizerWidget(contentDiv, widgetId) {
                contentDiv.innerHTML = `
                    <textarea class="summarizer-textarea" placeholder="Paste your text here to summarize..."></textarea>
                    <div class="summarizer-controls">
                        <button class="summarize-btn">Summarize</button>
                        <button class="clear-btn">Clear</button>
                    </div>
                    <div class="summarizer-output">
                        <p style="text-align: center; color: var(--text-color-light);">Summarized text will appear here.</p>
                    </div>
                `;

                const textarea = contentDiv.querySelector('.summarizer-textarea');
                const summarizeBtn = contentDiv.querySelector('.summarize-btn');
                const clearBtn = contentDiv.querySelector('.clear-btn');
                const outputDiv = contentDiv.querySelector('.summarizer-output');

                // Basic sentence tokenizer
                function tokenizeSentences(text) {
                    // This regex attempts to split sentences by common terminators (. ! ?)
                    // followed by a space or end of string, while trying to avoid splitting
                    // abbreviations (e.g., "Mr. Smith"). It's a simple approach.
                    const sentences = text.match(/[^.!?]+(?:[.!?]\s*|$)/g);
                    return sentences ? sentences.map(s => s.trim()).filter(s => s.length > 0) : [];
                }

                // Basic word tokenizer and cleaner
                function tokenizeWords(text) {
                    return text.toLowerCase().match(/\b\w+\b/g) || [];
                }

                function summarizeText(text, numSentences = 3) {
                    if (!text || text.trim() === '') {
                        return '<p style="text-align: center; color: var(--text-color-light);">Please enter some text to summarize.</p>';
                    }

                    const sentences = tokenizeSentences(text);
                    if (sentences.length <= numSentences) {
                        return sentences.map(s => `<p>${s}</p>`).join('');
                    }

                    const words = tokenizeWords(text);
                    const wordFrequency = {};
                    words.forEach(word => {
                        wordFrequency[word] = (wordFrequency[word] || 0) + 1;
                    });

                    // Assign a score to each sentence based on word frequency
                    const sentenceScores = sentences.map(sentence => {
                        const sentenceWords = tokenizeWords(sentence);
                        let score = 0;
                        sentenceWords.forEach(word => {
                            score += wordFrequency[word] || 0;
                        });
                        return { sentence, score };
                    });

                    // Sort sentences by score in descending order
                    sentenceScores.sort((a, b) => b.score - a.score);

                    // Take the top 'numSentences'
                    const topSentences = sentenceScores.slice(0, numSentences).map(item => item.sentence);

                    // Reorder sentences to appear in their original order
                    const finalSummarySentences = sentences.filter(s => topSentences.includes(s));

                    return finalSummarySentences.map(s => `<p>${s}</p>`).join('');
                }

                summarizeBtn.addEventListener('click', () => {
                    const text = textarea.value;
                    // You can let the user choose the number of sentences, or make it dynamic
                    const summary = summarizeText(text, 3); // Summarize to 3 sentences by default
                    outputDiv.innerHTML = summary;
                });

                clearBtn.addEventListener('click', () => {
                    textarea.value = '';
                    outputDiv.innerHTML = '<p style="text-align: center; color: var(--text-color-light);">Summarized text will appear here.</p>';
                });

                return {
                    destroy: () => {},
                    onResize: () => {}
                };
            }

            /**
             * NEW WIDGET: Drawing Board
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createDrawingBoardWidget(contentDiv, widgetId) {
    contentDiv.innerHTML = `
        <div class="drawing-board-controls">
            <label for="strokeColor-${widgetId}">Color:</label>
            <input type="color" id="strokeColor-${widgetId}" value="#000000">
            <label for="lineWidth-${widgetId}">Width:</label>
            <input type="range" id="lineWidth-${widgetId}" min="1" max="20" value="3">
            <button class="clear-canvas-btn"><i class="fas fa-eraser"></i> Clear</button>
            <button class="save-canvas-btn"><i class="fas fa-download"></i> Save</button>
        </div>
        <canvas class="drawing-canvas" style="display: block; width: 100%; height: calc(100% - 40px);"></canvas>
    `;

    const canvas = contentDiv.querySelector('.drawing-canvas');
    const ctx = canvas.getContext('2d');
    const strokeColorInput = contentDiv.querySelector(`#strokeColor-${widgetId}`);
    const lineWidthInput = contentDiv.querySelector(`#lineWidth-${widgetId}`);
    const clearBtn = contentDiv.querySelector('.clear-canvas-btn');
    const saveBtn = contentDiv.querySelector('.save-canvas-btn');

    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    let currentDrawingDataUrl = null;

    function setCanvasSize() {
        if (canvas.width > 0 && canvas.height > 0) {
            currentDrawingDataUrl = canvas.toDataURL();
        }

        const controlsHeight = contentDiv.querySelector('.drawing-board-controls').offsetHeight;
        const newWidth = contentDiv.clientWidth;
        const newHeight = contentDiv.clientHeight - controlsHeight;

        canvas.width = newWidth;
        canvas.height = newHeight;

        if (currentDrawingDataUrl) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = currentDrawingDataUrl;
        }
    }

    function draw(e) {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = strokeColorInput.value;
        ctx.lineWidth = lineWidthInput.value;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.stroke();

        lastX = x;
        lastY = y;
    }

    canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
    });

    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('mouseout', () => isDrawing = false);

    clearBtn.addEventListener('click', () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        currentDrawingDataUrl = null;
    });

    saveBtn.addEventListener('click', () => {
        const dataURL = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = `drawing_${new Date().toISOString()}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    setCanvasSize();

    return {
        destroy: () => {},
        onResize: () => setCanvasSize()
    };
}

            /**
             * NEW WIDGET: Music Player with Relaxing Sounds
             * @param {HTMLElement} contentDiv
             * @param {string} widgetId
             * @returns {object} Public API for the widget
             */
            function createMusicPlayerWidget(contentDiv, widgetId) {
                const sounds = [
                    { id: 'rain', name: 'Rain', file: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
                    { id: 'ocean-waves', name: 'Ocean Waves', file: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3' },
                    { id: 'forest-ambience', name: 'Forest Ambience', file: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3' },
                    { id: 'white-noise', name: 'White Noise', file: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3' },
                    { id: 'lofi-beats', name: 'Lofi Beats', file: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3' },
                    // NOTE: The above links are placeholders from soundhelix.com for demonstration.
                    // For a real app, you would use actual relaxing sounds, ideally hosted by yourself
                    // or from reliable public domain/royalty-free sources like:
                    // - FreeSound.org (requires attribution for many sounds)
                    // - Pixabay.com/music/ (royalty-free music)
                    // - Zapsplat.com (some free, some paid)
                ];

                const audioPlayers = {}; // Stores Audio objects by sound ID

                contentDiv.innerHTML = `
                    <div class="music-player-container">
                        <div class="music-sound-list"></div>
                    </div>
                `;

                const soundListContainer = contentDiv.querySelector('.music-sound-list');

                sounds.forEach(sound => {
                    const soundItem = document.createElement('div');
                    soundItem.classList.add('music-sound-item');
                    soundItem.innerHTML = `
                        <span>${sound.name}</span>
                        <div class="controls">
                            <button class="play-pause-btn" data-sound-id="${sound.id}"><i class="fas fa-play"></i></button>
                            <input type="range" class="volume-slider" min="0" max="1" step="0.01" value="0.5" data-sound-id="${sound.id}">
                        </div>
                    `;
                    soundListContainer.appendChild(soundItem);

                    const audio = new Audio(sound.file);
                    audio.loop = true; // Loop the sounds
                    audio.volume = 0.5; // Default volume
                    audioPlayers[sound.id] = audio;

                    const playPauseBtn = soundItem.querySelector('.play-pause-btn');
                    const volumeSlider = soundItem.querySelector('.volume-slider');

                    playPauseBtn.addEventListener('click', () => {
                        if (audio.paused) {
                            audio.play().then(() => {
                                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                            }).catch(error => {
                                console.error(`Error playing ${sound.name}:`, error);
                                showMessageBox(`Browser blocked autoplay for "${sound.name}". Please interact with the page first.`);
                            });
                        } else {
                            audio.pause();
                            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                        }
                    });

                    volumeSlider.addEventListener('input', (e) => {
                        audio.volume = parseFloat(e.target.value);
                    });
                });

                // Add a global control for all sounds (optional but nice)
                const globalControls = document.createElement('div');
                globalControls.style.cssText = `
                    display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 15px; flex-shrink: 0;
                    padding-top: 10px; border-top: 1px solid var(--tertiary-bg);
                `;
                globalControls.innerHTML = `
                    <button class="stop-all-btn"><i class="fas fa-stop"></i> Stop All</button>
                    <label for="masterVolume-${widgetId}">Master Volume:</label>
                    <input type="range" id="masterVolume-${widgetId}" min="0" max="1" step="0.01" value="1">
                `;
                contentDiv.appendChild(globalControls);

                const stopAllBtn = contentDiv.querySelector('.stop-all-btn');
                const masterVolumeSlider = contentDiv.querySelector(`#masterVolume-${widgetId}`);

                stopAllBtn.addEventListener('click', () => {
                    for (const id in audioPlayers) {
                        audioPlayers[id].pause();
                        audioPlayers[id].currentTime = 0; // Reset to start
                        contentDiv.querySelector(`button[data-sound-id="${id}"]`).innerHTML = '<i class="fas fa-play"></i>';
                    }
                });

                masterVolumeSlider.addEventListener('input', (e) => {
                    const masterVolume = parseFloat(e.target.value);
                    for (const id in audioPlayers) {
                        // Adjust individual sound volumes proportionally
                        // You might need to store original individual volumes if you want true master control
                        // For simplicity, this scales the current volume.
                        audioPlayers[id].volume = masterVolume * audioPlayers[id].dataset.originalVolume || masterVolume;
                    }
                });

                // Initialize original volumes for proportional master control
                for (const id in audioPlayers) {
                    audioPlayers[id].dataset.originalVolume = audioPlayers[id].volume;
                }


                return {
                    destroy: () => {
                        // Stop all sounds and release audio objects when widget is destroyed
                        for (const id in audioPlayers) {
                            audioPlayers[id].pause();
                            audioPlayers[id].src = ''; // Release audio resource
                        }
                    },
                    onResize: () => {
                        // Layout is flexible, no specific resize logic needed here
                    }
                };
            }


            // --- Initialization ---
            function initializeApp() {
                // 1. Apply saved theme and accent color immediately
                const savedTheme = loadSetting('theme', 'light');
                applyTheme(savedTheme);

                const savedAccentColor = loadSetting('accentColor', '#007bff');
                applyAccentColor(savedAccentColor);

                const savedBackgroundImage = loadSetting('backgroundImage', null);
                if (savedBackgroundImage) {
                    applyBackgroundImage(savedBackgroundImage);
                }

                // 2. Show welcome screen
                welcomeScreen.classList.add('visible');

                // Function to hide welcome screen and show app
                const hideWelcomeScreen = () => {
                    clearTimeout(welcomeScreenTimeoutId); // Clear the scheduled auto-hide
                    clearInterval(progressBarIntervalId); // Clear any active progress bar animation
                    getStartedProgressBar.style.width = '0%'; // Reset progress bar animation visually

                    welcomeScreen.classList.add('fade-out');
                    setTimeout(() => {
                        welcomeScreen.style.display = 'none'; // Completely remove after fade-out
                        populateWidgetPalette(); // Populate dashboard widgets after welcome screen is gone
                    }, 700); // Match fade-out transition duration
                };

                // Function to start progress bar animation (for automatic countdown only)
                const startProgressBar = () => {
                    // Only start if it's not already running (prevents multiple intervals if clicked multiple times very quickly)
                    if (progressBarIntervalId) return;

                    let progress = 0;
                    const duration = 1000; // 1 second for loading bar
                    const interval = 50; // Update every 50ms
                    const steps = duration / interval;
                    const increment = 100 / steps;

                    progressBarIntervalId = setInterval(() => {
                        progress += increment;
                        getStartedProgressBar.style.width = `${progress}%`;
                        if (progress >= 100) {
                            clearInterval(progressBarIntervalId);
                            hideWelcomeScreen(); // Trigger hide when auto-countdown finishes
                        }
                    }, interval);
                };


                // Set the timeout for the *automatic* progress bar start
                // This timeout's ID is stored in welcomeScreenTimeoutId
                welcomeScreenTimeoutId = setTimeout(startProgressBar, 5000); // Auto-start progress bar after 5 seconds

                // Event listener for "Get Started" button - immediately hides welcome screen
                // This will also clear the `welcomeScreenTimeoutId` before it fires, and `progressBarIntervalId` if it was already running.
                getStartedBtn.addEventListener('click', hideWelcomeScreen);
            }

            initializeApp();

        })(); // End of IIFE
    </script>

<!-- Tutorial Arrow -->
<div id="tutorial-arrow" style="
    position: fixed;
    bottom: 80px;
    right: 30px;
    background-color: var(--accent-color);
    color: white;
    padding: 10px 15px;
    border-radius: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: none;
    z-index: 9999;
    font-family: 'Inter', sans-serif;
    animation: bounce 1s infinite;
">
    Click here to add widgets! 
</div>

<style>
@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const getStartedBtn = document.querySelector(".get-started-btn");
    const addWidgetFab = document.getElementById("add-widget-fab");
    const tutorialArrow = document.getElementById("tutorial-arrow");

    if (getStartedBtn && tutorialArrow && addWidgetFab) {
        getStartedBtn.addEventListener("click", function () {
            tutorialArrow.style.display = "block";
        });

        addWidgetFab.addEventListener("click", function () {
            tutorialArrow.style.display = "none";
        });
    }
});
</script>

</body>
</html>